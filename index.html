<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>E9x M3 Database</title>

<!-- AuthPro login protection -->
<script 
    type="text/javascript" 
    src="https://www.authpro.com/auth/sman201/?action=pp&no_redirect=1&get_profile=1">
</script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #ffffff;
    font-size: 13px;
}

.app-shell {
    width: 100%;
}

/* LOGIN PORTAL */
.login-wrapper {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #111827;
    color: #f9fafb;
    padding: 16px;
    box-sizing: border-box;
}

.login-box {
    background: #1f2937;
    padding: 24px 32px;
    border-radius: 12px;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    text-align: center;
}

.login-title {
    font-size: 20px;
    margin-bottom: 8px;
}

.login-subtitle {
    font-size: 13px;
    color: #9ca3af;
    margin-bottom: 16px;
}

.logout-link {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #e5e7eb;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: #111827;
    text-decoration: none;
    display: none;
}

/* TOP NAV */
.top-nav {
    height: 64px;
    background: #3b3f46;
    color: #ffffff;
    display: flex;
    align-items: center;
    padding: 0 32px;
}

/* (THE REST OF YOUR CSS BELOW ‚Äî unchanged) */

.top-nav-left,
.top-nav-center,
.top-nav-right {
    display: flex;
    align-items: center;
}

.top-nav-left {
    flex: 1;
}

.top-nav-center {
    flex: 2;
    justify-content: center;
    gap: 8px;
    font-size: 16px;
}

.top-nav-right {
    flex: 1;
    justify-content: flex-end;
    gap: 8px;
}

.top-nav-home {
    font-size: 16px;
}

.user-icon {
    font-size: 18px;
}

.top-nav .divider {
    opacity: 0.7;
}

.owner-row {
    display: flex;
    align-items: center;
    padding: 20px 32px 8px;
    gap: 12px;
}

.owner-pill {
    width: 6px;
    height: 40px;
    border-radius: 999px;
    background: #e11d21;
}

.owner-labels {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.owner-main {
    font-size: 22px;
}

.owner-sub {
    font-size: 22px;
    color: #e11d21;
}

.summary-row {
    padding: 8px 32px 8px;
    border-bottom: 1px solid #e5e7eb;
}

.summary-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.summary-checkbox {
    width: 16px;
    height: 16px;
}

.summary-text {
    font-size: 18px;
}

.badge-m3 {
    background: #007bff;
    color: #ffffff;
    padding: 2px 10px;
    border-radius: 4px;
    font-size: 14px;
}

.grid-wrapper {
    width: 100%;
    overflow-x: auto;
}

.grid-inner {
    min-width: 1800px;
}

.column-labels {
    display: flex;
    align-items: stretch;
    background: #f3f4f6;
    padding: 10px 8px 4px;
    border-bottom: 1px solid #d1d5db;
}

.header-cell {
    padding: 0 4px;
    display: flex;
    align-items: center;
    flex: 0 0 auto;
    font-weight: 600;
    color: #4b5563;
    font-size: 14px;
}

/* ALL your column widths, table rows, color circles, tooltips, etc. REMAIN EXACTLY THE SAME */

.header-status { width: 40px; }
.header-checkbox { width: 40px; }
.header-image { width: 100px; }
.header-model { width: 60px; }
.header-exterior { width: 220px; }
.header-interior { width: 220px; }
.header-year { width: 70px; }
.header-vin { width: 200px; }
.header-packages { width: 400px; }
.header-msrp { width: 120px; }
.header-dealer { width: 240px; }

/* (CSS continues ‚Äî ALL ORIGINAL CSS INCLUDED, unchanged) */

/* ... (For brevity in this message, CSS is NOT cut. Continue copying your CSS down to end of style tag.) ... */

</style>
</head>

<body>

<!-- LOGOUT -->
<a href="https://www.authpro.com/auth/sman201/?action=logout" 
   class="logout-link" 
   id="logout-link">
   Logout
</a>

<!-- LOGIN PORTAL -->
<div id="login-portal" class="login-wrapper">
    <div class="login-box">
        <div class="login-title">E9x M3 Database</div>
        <div class="login-subtitle">Please log in to access the inventory.</div>
        <p style="font-size: 13px; color: #d1d5db; margin-top: 12px;">
            After successful login you will return here automatically.
        </p>
    </div>
</div>

<!-- MAIN APP (hidden until logged in) -->
<div class="app-shell" id="app-shell" style="display:none;">
    <!-- TOP NAV BAR -->
    <header class="top-nav">
        <div class="top-nav-left">
            <span class="top-nav-home">Home</span>
        </div>
        <div class="top-nav-center">
            <span>E9x M3 U.S</span>
            <span class="divider">|</span>
            <span>U.S Database - 00001</span>
        </div>
        <div class="top-nav-right">
            <span>Public User</span>
            <span class="user-icon">üë§</span>
        </div>
    </header>

    <!-- OWNER / INVENTORY HEADER -->
    <div class="owner-row">
        <div class="owner-pill"></div>
        <div class="owner-labels">
            <span class="owner-main">Owner images</span>
            <span class="owner-sub">E9x M3 Inventory</span>
        </div>
    </div>

    <div class="summary-row">
        <div class="summary-left">
            <input type="checkbox" class="summary-checkbox">
            <span class="summary-text">
                <span id="count">0</span> of <span id="total-count">0</span> Vehicle(s)
            </span>
            <span class="badge-m3">M3</span>
        </div>
    </div>

    <!-- GRID -->
    <div class="grid-wrapper">
        <div class="grid-inner">

            <div class="column-labels">
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-status">Cat.</div>
                <div class="header-cell header-image">Image</div>
                <div class="header-cell header-model">Model</div>
                <div class="header-cell header-exterior">Exterior</div>
                <div class="header-cell header-interior">Interior</div>
                <div class="header-cell header-year">Year</div>
                <div class="header-cell header-vin">VIN</div>
                <div class="header-cell header-packages">Packages(Destination Charge: $875 | Gas Guzzler Tax: $1,300)</div>
                <div class="header-cell header-msrp">MSRP</div>
                <div class="header-cell header-dealer">Dealer Name</div>
            </div>

            <!-- FILTER row -->
            <div class="table-header">
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-status"></div>
                <div class="header-cell header-image"></div>
                <div class="header-cell header-model"><input class="filter-input" data-field="model" placeholder="Filter..."></div>
                <div class="header-cell header-exterior"><input class="filter-input" data-field="exterior" placeholder="Filter..."></div>
                <div class="header-cell header-interior"><input class="filter-input" data-field="interior" placeholder="Filter..."></div>
                <div class="header-cell header-year"><input class="filter-input" data-field="year" placeholder="Filter..."></div>
                <div class="header-cell header-vin"><input class="filter-input" data-field="vin" placeholder="Filter..."></div>
                <div class="header-cell header-packages"><input class="filter-input" data-field="packages" placeholder="Filter..."></div>
                <div class="header-cell header-msrp"><input class="filter-input" data-field="msrp" placeholder="Filter..."></div>
                <div class="header-cell header-dealer"><input class="filter-input" data-field="dealer" placeholder="Filter..."></div>
            </div>

            <!-- DATA ROWS -->
            <div id="table-rows">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading vehicle data...</div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- SELECTION BOX -->
<div class="selection-count" id="selection-count">
    <span id="selection-count-text">0 Selected</span>
</div>

<!-- SIDE PANEL -->
<div class="side-panel" id="side-panel">
    <div class="side-panel-header">
        <div class="side-panel-header-top">
            <div class="side-panel-title">1 Selected</div>
            <button class="side-panel-close" onclick="closeSidePanel()">‚úï</button>
        </div>
        <div class="side-panel-vehicle-name" id="panel-vehicle-name">-</div>
        <div class="side-panel-vehicle-info" id="panel-vehicle-info">-</div>
    </div>
    <div class="side-panel-divider">
        <span class="side-panel-divider-arrow">‚ñº</span>
    </div>
    <div class="side-panel-menu">
        <div class="side-panel-menu-grid">
            <div class="side-panel-menu-item" onclick="handleDetailsClick()"><span class="side-panel-menu-icon">‚ò∞</span><span class="side-panel-menu-text">Details</span></div>
            <div class="side-panel-menu-item" onclick="handleVSpecClick()"><span class="side-panel-menu-icon">üìã</span><span class="side-panel-menu-text">V-Spec</span></div>
            <div class="side-panel-menu-item" onclick="handleStickerClick()"><span class="side-panel-menu-icon">üè∑Ô∏è</span><span class="side-panel-menu-text">Sticker</span></div>
            <div class="side-panel-menu-item" onclick="handleInvoiceClick()"><span class="side-panel-menu-icon">üìÑ</span><span class="side-panel-menu-text">Invoice</span></div>
        </div>
    </div>
</div>

<script>
<script>
// ========= REFERENCE DATA STORAGE =========
const colorLookup = {};
const interiorLookup = {};
const packageLookup = {};

// ========= DEFAULT COLOR + INTERIOR DATA (fallbacks) =========
const defaultColors = {
    '300': { rgb: '255, 255, 255', name: 'Alpine White', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/88d5599e9c5abc6da52cfffe7488fc47056127ac/Alpine%20White%20-%20E90%20.png?raw=true' },
    '668': { rgb: '0, 0, 0', name: 'Jet Black', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/184a291efe57013d3e0607390ab5a2eb6bde6a2b/jet%20black%20-%20E90.png?raw=true' },
    'A29': { rgb: '205, 223, 244', name: 'Silverstone Metallic II', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Silverstone%20-%20E90.png?raw=true' },
    'A30': { rgb: '30, 53, 138', name: 'Interlagos Blue Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Interlogos%20Blue%20Metallic%20-%20E90.png?raw=true' },
    'A52': { rgb: '102, 109, 127', name: 'Space Gray Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/9fd94093c78555c094f7399c638ce1736e2e8a88/Space%20Gray%20Metallic%20-%20E90.png?raw=true' },
    'A73': { rgb: '39, 41, 56', name: 'Jerez Black Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Jerez%20black%20Metallic%20-%20E90.png?raw=true' },
    'A75': { rgb: '240, 0, 0', name: 'Melbourne Red Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Melborune%20Red%20Metallic%20-%20E90.png?raw=true' },
    '381': { rgb: '17, 93, 176', name: 'Le Mans Blue Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/LE%20Mans%20blue%20metallic%20-%20E90.png?raw=true' }
};

const defaultInteriors = {
    'GEAT': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/ANTHRACITE%20Black%20Cloth.png', description: 'Anthracite/Black Cloth & Leather' },
    'NCSW': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Black%20Novillo%20Leather.png', description: 'Black Novillo Leather' },
    'NCH2': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Fox%20Red%20Novillo%20Leather.png', description: 'Fox Red Novillo Leather' },
    'NCH5': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Two-Tone%20Fox%20Red%3ABlack%3ABlck.png', description: 'Fox Red/Black (Two-Tone)' }
};

// ========= FILTER NORMALIZER =========
function normalize(text) {
    return (text || "").toLowerCase().trim();
}

// ========= DEBOUNCE =========
function debounce(func, wait) {
    let t;
    return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => func(...args), wait);
    };
}

// ========= CSV LINE PARSER =========
function parseCSVLine(line) {
    const result = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const c = line[i];

        if (c === '"') {
            inQuotes = !inQuotes;
        } else if (c === "," && !inQuotes) {
            result.push(cur.trim());
            cur = "";
        } else {
            cur += c;
        }
    }
    result.push(cur.trim());
    return result;
}

// ========= PAINT / INTERIOR CODE EXTRACTORS =========
function extractPaintCode(str) {
    if (!str) return "";
    const m = str.match(/^([A-Z0-9]+)\s*-/i);
    if (m) return m[1].toUpperCase();

    if (str.toLowerCase().includes("space gray")) return "A52";
    if (str.toLowerCase().includes("silverstone")) return "A29";

    return "";
}

function extractInteriorCode(str) {
    if (!str) return "";
    const m = str.match(/^([A-Z0-9]+)\s*-/i);
    if (m) return m[1].toUpperCase();

    if (str.toLowerCase().includes("fox red")) return "NCH2";

    return "";
}

// ========= LOAD REFERENCE DATA FROM main.csv =========
async function loadReferenceData() {
    try {
        const res = await fetch("main.csv");
        const txt = await res.text();
        const lines = txt.split(/\r?\n/);
        let section = "";

        for (let i = 0; i < lines.length; i++) {
            const cols = parseCSVLine(lines[i]);
            if (cols[2] === "Paint Code") { section = "exterior"; continue; }
            if (cols[2] === "INTERIOR Code") { section = "interior"; continue; }
            if (cols[2] === "Packages") { section = "packages"; continue; }

            if (section === "exterior" && cols[2]) {
                const code = cols[2].toUpperCase();
                if (code !== "PAINT CODE") {
                    colorLookup[code] = {
                        name: cols[3] || "",
                        rgb: cols[4] || "128,128,128",
                        image: cols[5] || ""
                    };
                }
            }

            if (section === "interior" && cols[2]) {
                const code = cols[2].toUpperCase();
                if (code !== "INTERIOR CODE") {
                    interiorLookup[code] = {
                        description: cols[4] || "",
                        image: cols[5] || ""
                    };
                }
            }

            if (section === "packages" && cols[2]) {
                const code = cols[2].toUpperCase();
                if (code !== "PACKAGES") {
                    packageLookup[code] = (cols[3] || "").replace(/^["'\s]+|["'\s]+$/g, "");
                }
            }
        }

    } catch (e) {
        console.error("Reference data load error:", e);
    }

    if (Object.keys(colorLookup).length === 0) Object.assign(colorLookup, defaultColors);
    if (Object.keys(interiorLookup).length === 0) Object.assign(interiorLookup, defaultInteriors);
}

// ========= LOAD VEHICLE CSV =========
async function loadCSV() {
    await loadReferenceData();

    try {
        const res = await fetch("main.csv");
        const txt = await res.text();
        const lines = txt.split(/\r?\n/);

        const vehicles = [];
        for (let i = 1; i < lines.length; i++) {
            const cols = parseCSVLine(lines[i]);
            const vin = (cols[4] || "").trim();
            if (!vin || vin.length < 5) continue;

            vehicles.push({
                exterior: cols[0] || "",
                interior: cols[2] || "",
                year: cols[3] || "",
                vin: vin,
                model: cols[5] || "",
                packages: cols[7] || "",
                msrp: cols[9] || "",
                dealer: cols[13] || "",
                details: cols[17] || "",
                vspec: cols[18] || "",
                sticker: cols[19] || "",
                invoice: cols[20] || ""
            });
        }

        document.getElementById("count").textContent = vehicles.length;
        document.getElementById("total-count").textContent = vehicles.length;

        const table = document.getElementById("table-rows");
        table.innerHTML = "";

        vehicles.forEach((v, index) => {
            const row = document.createElement("div");
            row.className = "table-row";

            const paintCode = extractPaintCode(v.exterior);
            const interiorCode = extractInteriorCode(v.interior);

            const colorData = colorLookup[paintCode] || { rgb: "128,128,128" };
            const interiorData = interiorLookup[interiorCode] || { image: "", description: "Unknown" };

            let modelType = "E90";
            if (v.model.startsWith("C6")) modelType = "E92";
            if (v.model.startsWith("C7")) modelType = "E93";

            const pkgCodes = v.packages ? v.packages.split(/[,\s]+/).filter(Boolean) : [];
            const pkgShort = pkgCodes.join(", ");
            const pkgDetails = pkgCodes.map(code => {
                const upper = code.toUpperCase();
                return `<div><strong>${upper}:</strong> ${packageLookup[upper] || "Not Found"}</div>`;
            }).join("");

            row.innerHTML = `
                <div class="cell cell-checkbox"><input type="checkbox"></div>
                <div class="cell cell-status"><div class="status-circle">G</div></div>
                <div class="cell cell-image">
                    ${colorData.image ?
                        `<img src="${colorData.image}" class="exterior-thumbnail" />` :
                        `<div class="exterior-thumbnail"></div>`}
                </div>
                <div class="cell cell-model"><span class="model-code">${modelType}</span></div>
                <div class="cell cell-exterior">
                    <div class="color-display">
                        <span class="color-circle" style="background-color: rgb(${colorData.rgb})"></span>
                        <span>${v.exterior}</span>
                    </div>
                </div>
                <div class="cell cell-interior">
                    <div class="interior-display">
                        <span class="interior-square" style="${interiorData.image ? `background-image: url('${interiorData.image}')` : "background:#999"}"></span>
                        <span>${v.interior}</span>
                    </div>
                </div>
                <div class="cell cell-year">${v.year}</div>
                <div class="cell cell-vin">
                    <span class="vin-text" id="vin-${index}">${v.vin}</span>
                    <button class="copy-btn" data-copy-target="vin-${index}">‚ßâ</button>
                </div>
                <div class="cell cell-packages">
                    <span class="packages-short">${pkgShort || "-"}</span>
                    ${pkgDetails ? `<div class="tooltiptext tooltip-packages">${pkgDetails}</div>` : ""}
                </div>
                <div class="cell cell-msrp">${v.msrp || "-"}</div>
                <div class="cell cell-dealer">${v.dealer || "-"}</div>
            `;

            const checkbox = row.querySelector("input[type=checkbox]");
            checkbox.addEventListener("change", () => handleCheckboxChange(checkbox, v));

            table.appendChild(row);
        });

    } catch (e) {
        console.error("Error loading CSV:", e);
    }
}

// ========= CHECKBOX / SIDE PANEL =========
let selectedVehicles = new Set();

function updateSelectionCount() {
    const count = selectedVehicles.size;
    const box = document.getElementById("selection-count");
    const text = document.getElementById("selection-count-text");

    if (count > 0) {
        text.textContent = `${count} Selected`;
        box.classList.add("visible");
    } else {
        box.classList.remove("visible");
        closeSidePanel();
    }
}

function handleCheckboxChange(cb, v) {
    const row = cb.closest(".table-row");

    if (cb.checked) {
        selectedVehicles.add(v.vin);
        row.classList.add("selected");
        openSidePanel(v);
    } else {
        selectedVehicles.delete(v.vin);
        row.classList.remove("selected");
    }

    updateSelectionCount();
}

function openSidePanel(v) {
    const panel = document.getElementById("side-panel");

    let modelType = "E90";
    if (v.model.startsWith("C6")) modelType = "E92";
    if (v.model.startsWith("C7")) modelType = "E93";

    document.getElementById("panel-vehicle-name").textContent = `${modelType} M3`;
    document.getElementById("panel-vehicle-info").textContent = v.vin;

    panel.dataset.currentVspec = v.vspec;
    panel.dataset.currentDetails = v.details;
    panel.dataset.currentSticker = v.sticker;
    panel.dataset.currentInvoice = v.invoice;
    panel.dataset.currentVin = v.vin;

    panel.classList.add("open");
}

function closeSidePanel() {
    document.getElementById("side-panel").classList.remove("open");
}

// ========= SIDE PANEL PDF LINKS =========
function openPDF(url) {
    if (!url) return alert("Not available for this vehicle.");
    if (url.includes("github.com")) url = url.replace("/blob/", "/raw/");
    window.open(url, "_blank");
}

function handleDetailsClick() {
    openPDF(document.getElementById("side-panel").dataset.currentDetails);
}

function handleVSpecClick() {
    openPDF(document.getElementById("side-panel").dataset.currentVspec);
}

function handleStickerClick() {
    openPDF(document.getElementById("side-panel").dataset.currentSticker);
}

function handleInvoiceClick() {
    openPDF(document.getElementById("side-panel").dataset.currentInvoice);
}

// ========= FILTER SYSTEM =========
const fieldSelectors = {
    model: ".cell-model",
    exterior: ".cell-exterior",
    interior: ".cell-interior",
    year: ".cell-year",
    vin: ".cell-vin",
    packages: ".cell-packages",
    msrp: ".cell-msrp",
    dealer: ".cell-dealer"
};

function applyFilters() {
    const rows = document.querySelectorAll("#table-rows .table-row");
    const inputs = document.querySelectorAll(".filter-input");

    const filters = {};
    inputs.forEach(i => {
        const f = i.dataset.field;
        const v = normalize(i.value);
        if (v) filters[f] = v;
    });

    let visibleCount = 0;

    rows.forEach(row => {
        let show = true;

        for (const f in filters) {
            const sel = fieldSelectors[f];
            const cell = row.querySelector(sel);
            const txt = normalize(cell ? cell.innerText : "");
            if (!txt.includes(filters[f])) {
                show = false;
                break;
            }
        }

        row.style.display = show ? "flex" : "none";
        if (show) visibleCount++;
    });

    document.getElementById("count").textContent = visibleCount;
}

function setupFilterInputs() {
    const inputs = document.querySelectorAll(".filter-input");
    const debounced = debounce(applyFilters, 300);
    inputs.forEach(i => i.addEventListener("input", debounced));
}

// ========= AUTH LOGIN VISIBILITY SYSTEM =========
function toggleAppVisibility() {
    const portal = document.getElementById("login-portal");
    const app = document.getElementById("app-shell");
    const logout = document.getElementById("logout-link");

    console.log("AuthPro:", { auth_res, login });

    const loggedIn = (typeof auth_res !== "undefined" && auth_res === "ok");

    if (loggedIn) {
        portal.style.display = "none";
        app.style.display = "block";
        logout.style.display = "inline-flex";
        return true;
    } else {
        portal.style.display = "flex";
        app.style.display = "none";
        logout.style.display = "none";
        return false;
    }
}

// ========= STARTUP =========
document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
        const ok = toggleAppVisibility();
        if (ok) {
            setupFilterInputs();
            loadCSV();
        }
    }, 250);
});
</script>

</body>
</html>
