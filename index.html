<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E9x M3 Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #ffffff;
            font-size: 13px;
        }

        .app-shell {
            width: 100%;
        }

        /* TOP NAV */
        .top-nav {
            height: 64px;
            background: #3b3f46;
            color: #ffffff;
            display: flex;
            align-items: center;
            padding: 0 32px;
            box-sizing: border-box;
        }

        .top-nav-left,
        .top-nav-center,
        .top-nav-right {
            display: flex;
            align-items: center;
        }

        .top-nav-left {
            flex: 1;
        }

        .top-nav-center {
            flex: 2;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
        }

        .top-nav-right {
            flex: 1;
            justify-content: flex-end;
            gap: 8px;
        }

        .top-nav-home {
            font-size: 16px;
        }

        .user-icon {
            font-size: 18px;
        }

        .top-nav .divider {
            opacity: 0.7;
        }

        /* OWNER ROW */
        .owner-row {
            display: flex;
            align-items: center;
            padding: 20px 32px 8px;
            box-sizing: border-box;
            gap: 12px;
        }

        .owner-pill {
            width: 6px;
            height: 40px;
            border-radius: 999px;
            background: #e11d21;
        }

        .owner-labels {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .owner-main {
            font-size: 22px;
        }

        .owner-sub {
            font-size: 22px;
            color: #e11d21;
        }

        /* SUMMARY ROW */
        .summary-row {
            padding: 8px 32px 8px;
            border-bottom: 1px solid #e5e7eb;
            box-sizing: border-box;
        }

        .summary-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-checkbox {
            width: 16px;
            height: 16px;
        }

        .summary-text {
            font-size: 18px;
        }

        .badge-m3 {
            background: #007bff;
            color: #ffffff;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        /* GRID WRAPPER */
        .grid-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        .grid-inner {
            min-width: 1800px;
        }

        /* COLUMN LABELS */
        .column-labels {
            display: flex;
            align-items: stretch;
            background: #f3f4f6;
            padding: 10px 8px 4px;
            box-sizing: border-box;
            border-bottom: 1px solid #d1d5db;
        }

        .header-cell {
            padding: 0 4px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            flex: 0 0 auto;
            font-weight: 600;
            color: #4b5563;
            font-size: 14px;
        }

        .header-status { width: 40px; }
        .header-checkbox { width: 40px; }
        .header-image { width: 100px; }
        .header-model { width: 60px; }
        .header-exterior { width: 220px; }
        .header-interior { width: 220px; }
        .header-year { width: 70px; }
        .header-vin { width: 200px; }
        .header-packages { width: 400px; }
        .header-msrp { width: 120px; }
        .header-dealer { width: 240px; }

        .cell-status { width: 40px; }
        .cell-checkbox { width: 40px; }
        .cell-image { width: 100px; }
        .cell-model { width: 60px; }
        .cell-exterior { width: 220px; }
        .cell-interior { width: 220px; }
        .cell-year { width: 70px; }
        .cell-vin { width: 200px; }
        .cell-packages { width: 400px; }
        .cell-msrp { width: 120px; }
        .cell-dealer { width: 240px; }

        /* Side Panel Styles */
        .side-panel {
            position: fixed;
            right: -400px;
            top: 64px;
            width: 400px;
            height: calc(100vh - 64px);
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .side-panel.open {
            right: 0;
        }

        .side-panel-header {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .side-panel-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .side-panel-title {
            font-size: 13px;
            color: #6b7280;
        }

        .side-panel-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
        }

        .side-panel-close:hover {
            color: #1f2937;
        }

        .side-panel-vehicle-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .side-panel-vehicle-info {
            font-size: 13px;
            color: #6b7280;
        }

        .side-panel-divider {
            background: #dc2626;
            padding: 8px 0;
            text-align: center;
            cursor: pointer;
        }

        .side-panel-divider-arrow {
            color: white;
            font-size: 14px;
        }

        .side-panel-menu {
            background: #dc2626;
            padding: 0;
        }

        .side-panel-menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .side-panel-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 16px;
            background: #dc2626;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            min-height: 80px;
        }

        .side-panel-menu-item:nth-child(2n) {
            border-right: none;
        }

        .side-panel-menu-item:hover {
            background: #b91c1c;
        }

        .side-panel-menu-icon {
            margin-bottom: 8px;
            font-size: 18px;
        }

        .side-panel-menu-text {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        /* Selection indicator */
        .selection-count {
            position: fixed;
            top: 72px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
            font-weight: 600;
            z-index: 999;
            display: none;
        }

        .selection-count.visible {
            display: block;
        }

        /* Checkbox styling */
        .cell-checkbox input[type="checkbox"]:checked {
            accent-color: #2563eb;
        }

        /* Selected row highlight */
        .table-row.selected {
            background: #dbeafe !important;
            border-left: 3px solid #2563eb;
        }

        /* FILTER ROW */
        .table-header {
            display: flex;
            align-items: center;
            background: #eceff1;
            padding: 4px 8px;
            border-bottom: 1px solid #d1d5db;
        }

        .filter-input {
            width: 100%;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 13px;
            height: 26px;
        }

        /* Status circle */
        .status-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #10b981;
            color: #ffffff;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Checkbox */
        .cell-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* DATA ROWS */
        .table-row {
            display: flex;
            align-items: center;
            padding: 12px 8px;
            background: #f3f4f6;
            border-bottom: 1px solid #ddd;
            min-height: 50px;
        }

        .table-row:nth-child(even) {
            background: #eceff1;
        }

        .cell {
            padding: 0 4px;
            display: flex;
            align-items: center;
            font-size: 14px;
            line-height: 1.4;
            box-sizing: border-box;
            flex: 0 0 auto;
        }

        /* Exterior image */
        .exterior-thumbnail {
            width: 90px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            background: #f3f4f6;
        }

        /* Model code */
        .model-code {
            font-weight: 600;
            color: #1e293b;
            font-size: 13px;
        }

        /* Color display */
        .color-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #999;
            flex-shrink: 0;
        }

        /* Interior display */
        .interior-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .interior-square {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background-size: cover;
            background-position: center;
            border: 1px solid #999;
            flex-shrink: 0;
        }

        /* VIN styling */
        .cell-vin {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            gap: 6px;
        }

        .vin-text {
            display: inline-block;
            color: #111827;
            padding: 0;
            font-weight: 500;
            letter-spacing: 0.02em;
            font-size: 13px;
        }

        .cell-msrp {
            font-weight: 600;
            color: #059669;
        }

        /* Packages display */
        .packages-short {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 380px;
        }

        /* Copy button */
        .copy-btn {
            border: 1px solid #d1d5db;
            background: #f9fafb;
            border-radius: 4px;
            font-size: 11px;
            padding: 2px 5px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #e5e7eb;
        }

        .copy-btn.copied {
            background: #16a34a;
            border-color: #16a34a;
            color: #fff;
        }

        /* TOOLTIP */
        .tooltip {
            position: relative;
        }

        .tooltiptext {
            display: none;
            position: absolute;
            z-index: 20;
        }

        .tooltip:hover .tooltiptext {
            display: block;
        }

        .tooltip-red-content {
            background: #b91c1c;
            color: #fff;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.35;
            top: 110%;
            left: 0;
            white-space: nowrap;
            box-shadow: 0 8px 18px rgba(0,0,0,0.35);
        }

        .tooltip-packages {
            background: #b91c1c;
            color: #fff;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            top: 110%;
            left: 0;
            min-width: 300px;
            max-width: 450px;
            white-space: normal;
            box-shadow: 0 8px 18px rgba(0,0,0,0.35);
        }

        .tooltip-packages div {
            margin: 4px 0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="app-shell">

    <!-- TOP NAV BAR -->
    <header class="top-nav">
        <div class="top-nav-left">
            <span class="top-nav-home">Home</span>
        </div>
        <div class="top-nav-center">
            <span>E9x M3 U.S</span>
            <span class="divider">|</span>
            <span>U.S Database - 00001</span>
        </div>
        <div class="top-nav-right">
            <span>Public User</span>
            <span class="user-icon">üë§</span>
        </div>
    </header>

    <!-- OWNER / INVENTORY HEADER -->
    <div class="owner-row">
        <div class="owner-pill"></div>
        <div class="owner-labels">
            <span class="owner-main">Owner images</span>
            <span class="owner-sub">E9x M3 Inventory</span>
        </div>
    </div>

    <!-- SUMMARY ROW -->
    <div class="summary-row">
        <div class="summary-left">
            <input type="checkbox" class="summary-checkbox">
            <span class="summary-text">
                <span id="count">0</span> of <span id="total-count">0</span> Vehicle(s)
            </span>
            <span class="badge-m3">M3</span>
        </div>
    </div>

    <!-- GRID -->
    <div class="grid-wrapper">
        <div class="grid-inner">

            <!-- COLUMN LABELS -->
            <div class="column-labels">
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-status">Cat.</div>
                <div class="header-cell header-image">Image</div>
                <div class="header-cell header-model">Model</div>
                <div class="header-cell header-exterior">Exterior</div>
                <div class="header-cell header-interior">Interior</div>
                <div class="header-cell header-year">Year</div>
                <div class="header-cell header-vin">VIN</div>
                <div class="header-cell header-packages">Packages</div>
                <div class="header-cell header-msrp">MSRP</div>
                <div class="header-cell header-dealer">Dealer Name</div>
            </div>

            <!-- FILTER INPUT ROW -->
            <div class="table-header">
                <div class="header-cell header-checkbox">
                    <!-- No filter -->
                </div>
                <div class="header-cell header-status">
                    <!-- No filter -->
                </div>
                <div class="header-cell header-image">
                    <!-- No filter for image -->
                </div>
                <div class="header-cell header-model">
                    <input class="filter-input" data-field="model" placeholder="Filter...">
                </div>
                <div class="header-cell header-exterior">
                    <input class="filter-input" data-field="exterior" placeholder="Filter...">
                </div>
                <div class="header-cell header-interior">
                    <input class="filter-input" data-field="interior" placeholder="Filter...">
                </div>
                <div class="header-cell header-year">
                    <input class="filter-input" data-field="year" placeholder="Filter...">
                </div>
                <div class="header-cell header-vin">
                    <input class="filter-input" data-field="vin" placeholder="Filter...">
                </div>
                <div class="header-cell header-packages">
                    <input class="filter-input" data-field="packages" placeholder="Filter...">
                </div>
                <div class="header-cell header-msrp">
                    <input class="filter-input" data-field="msrp" placeholder="Filter...">
                </div>
                <div class="header-cell header-dealer">
                    <input class="filter-input" data-field="dealer" placeholder="Filter...">
                </div>
            </div>

            <!-- DATA ROWS INJECTED HERE -->
            <div id="table-rows">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading vehicle data...</div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Selection Counter -->
<div class="selection-count" id="selection-count">
    <span id="selection-count-text">0 Selected</span>
</div>

<!-- Side Panel -->
<div class="side-panel" id="side-panel">
    <div class="side-panel-header">
        <div class="side-panel-header-top">
            <div class="side-panel-title">1 Selected</div>
            <button class="side-panel-close" onclick="closeSidePanel()">‚úï</button>
        </div>
        <div class="side-panel-vehicle-name" id="panel-vehicle-name">-</div>
        <div class="side-panel-vehicle-info" id="panel-vehicle-info">-</div>
    </div>
    <div class="side-panel-divider">
        <span class="side-panel-divider-arrow">‚ñº</span>
    </div>
    <div class="side-panel-menu">
        <div class="side-panel-menu-grid">
            <div class="side-panel-menu-item" onclick="handleDetailsClick()">
                <span class="side-panel-menu-icon">‚ò∞</span>
                <span class="side-panel-menu-text">Details</span>
            </div>
            <div class="side-panel-menu-item" onclick="handleVSpecClick()">
                <span class="side-panel-menu-icon">üìã</span>
                <span class="side-panel-menu-text">V-Spec</span>
            </div>
            <div class="side-panel-menu-item" onclick="handleStickerClick()">
                <span class="side-panel-menu-icon">üè∑Ô∏è</span>
                <span class="side-panel-menu-text">Sticker</span>
            </div>
            <div class="side-panel-menu-item" onclick="handleInvoiceClick()">
                <span class="side-panel-menu-icon">üìÑ</span>
                <span class="side-panel-menu-text">Invoice</span>
            </div>
        </div>
    </div>
</div>

<script>
// Reference data storage - will be populated from reference.csv
const colorLookup = {};
const interiorLookup = {};
const packageLookup = {};

// Hardcoded reference data as fallback
const defaultColors = {
    '300': { rgb: '255, 255, 255', name: 'Alpine White', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/88d5599e9c5abc6da52cfffe7488fc47056127ac/Alpine%20White%20-%20E90%20.png?raw=true' },
    '668': { rgb: '0, 0, 0', name: 'Jet Black', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/184a291efe57013d3e0607390ab5a2eb6bde6a2b/jet%20black%20-%20E90.png?raw=true' },
    'A29': { rgb: '205, 223, 244', name: 'Silverstone Metallic II', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Silverstone%20-%20E90.png?raw=true' },
    'A30': { rgb: '30, 53, 138', name: 'Interlogos Blue Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Interlogos%20Blue%20Metallic%20-%20E90.png?raw=true' },
    'A52': { rgb: '102, 109, 127', name: 'Space Gray Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/9fd94093c78555c094f7399c638ce1736e2e8a88/Space%20Gray%20Metallic%20-%20E90.png?raw=true' },
    'A73': { rgb: '39, 41, 56', name: 'Jerez Black Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Jerez%20black%20Metallic%20-%20E90.png?raw=true' },
    'A75': { rgb: '240, 0, 0', name: 'Melbourne Red Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Melborune%20Red%20Metallic%20-%20E90.png?raw=true' },
    '381': { rgb: '17, 93, 176', name: 'Le Mans Blue Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/LE%20Mans%20blue%20metallic%20-%20E90.png?raw=true' },
    'SPACE GRAY': { rgb: '102, 109, 127', name: 'Space Gray Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/9fd94093c78555c094f7399c638ce1736e2e8a88/Space%20Gray%20Metallic%20-%20E90.png?raw=true' }
};

const defaultInteriors = {
    'GEAT': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/ANTHRACITE%20Black%20Cloth.png', description: 'Anthracite/Black Cloth & Leather' },
    'NCSW': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Black%20Novillo%20Leather.png', description: 'Black Novillo Leather' },
    'NDSW': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Black%20Novillo%20Leather.png', description: 'Black Extended Novillo Leather' },
    'NCH1': { image: 'https://github.com/Sman19/E9x-Interiors/raw/05d770702ebbc9b3ba42808fbf60364a59a2bca1/Silver%20Novillo%20Leather.png', description: 'Palladium/Silver Novillo Leather' },
    'NDH1': { image: 'https://github.com/Sman19/E9x-Interiors/raw/05d770702ebbc9b3ba42808fbf60364a59a2bca1/Silver%20Novillo%20Leather.png', description: 'Palladium Extended Novillo Leather' },
    'NCH2': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Fox%20Red%20Novillo%20Leather.png', description: 'Fox Red Novillo Leather' },
    'NDH2': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Fox%20Red%20Novillo%20Leather.png', description: 'Fox Red Extended Novillo Leather' },
    'NCH3': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Bamboo%20Beige%20Novillo%20Leather.png', description: 'Bamboo Beige Novillo Leather' },
    'NDH3': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Bamboo%20Beige%20Novillo%20Leather.png', description: 'Bamboo Beige Extended Novillo Leather' },
    'NCH4': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Black%3APadllaium%20Two-TOne.png', description: 'Palladium/Black Novillo Leather (Two-Tone)' },
    'NCH5': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Two-Tone%20Fox%20Red%3ABlack%3ABlck.png', description: 'Fox Red/Black Novillo Leather (Two-Tone)' },
    'NDH5': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Two-Tone%20Fox%20Red%3ABlack%3ABlck.png', description: 'Fox Red/Black Extended Novillo Leather (Two-Tone)' },
    'FOX RED': { image: 'https://github.com/Sman19/E9x-Interiors/raw/c588c491108fbe4764bc1ff8c49809dc0991fa32/Fox%20Red%20Novillo%20Leather.png', description: 'Fox Red Extended Novillo Leather' }
};

// Field selectors for filtering
const fieldSelectors = {
    model: '.cell-model',
    exterior: '.cell-exterior',
    interior: '.cell-interior',
    year: '.cell-year',
    vin: '.cell-vin',
    packages: '.cell-packages',
    msrp: '.cell-msrp',
    dealer: '.cell-dealer'
};

function normalize(text) {
    return (text || '').toLowerCase().trim();
}

// Debounce function for better filter performance
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function applyFilters() {
    const rows = document.querySelectorAll('#table-rows .table-row');
    const inputs = document.querySelectorAll('.filter-input');

    const filters = {};
    inputs.forEach(input => {
        const field = input.dataset.field;
        const value = normalize(input.value);
        if (value) filters[field] = value;
    });

    let visibleCount = 0;
    rows.forEach(row => {
        let visible = true;
        for (const field in filters) {
            const selector = fieldSelectors[field];
            if (!selector) continue;
            const cell = row.querySelector(selector);
            const cellText = normalize(cell ? cell.innerText : '');
            if (!cellText.includes(filters[field])) {
                visible = false;
                break;
            }
        }
        row.style.display = visible ? 'flex' : 'none';
        if (visible) visibleCount++;
    });

    document.getElementById('count').textContent = visibleCount;
}

function setupFilterInputs() {
    const debouncedFilter = debounce(applyFilters, 300);
    document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('input', debouncedFilter);
    });
}

function initCopyButtons() {
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.copyTarget;
            const el = document.getElementById(id);
            if (!el) return;
            const text = el.textContent.trim();

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    btn.classList.add('copied');
                    btn.textContent = '‚úì';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.textContent = '‚ßâ';
                    }, 700);
                });
            }
        };
    });
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current.trim());
    return result;
}

// Extract paint code from exterior string (e.g., "A75 - Melbourne Red" -> "A75")
function extractPaintCode(exteriorStr) {
    if (!exteriorStr) return '';
    exteriorStr = exteriorStr.trim();
    
    // Try to match code at the beginning (e.g., "A75 - ", "300 - ", "381 - ")
    const codeMatch = exteriorStr.match(/^([A-Z0-9]+)\s*-/i);
    if (codeMatch) {
        return codeMatch[1].trim().toUpperCase();
    }
    
    // Handle "Space Gray Metallic" without code prefix
    if (exteriorStr.toLowerCase().includes('space gray')) {
        return 'A52';
    }
    
    // Handle "Silverstone" variations
    if (exteriorStr.toLowerCase().includes('silverstone')) {
        return 'A29';
    }
    
    return '';
}

// Extract interior code from interior string (e.g., "GEAT - ANTHRACITE CLOTH" -> "GEAT")
function extractInteriorCode(interiorStr) {
    if (!interiorStr) return '';
    interiorStr = interiorStr.trim();
    
    // Try to match code at the beginning (e.g., "GEAT - ", "NCH2 - ", "NDH3 - ")
    const codeMatch = interiorStr.match(/^([A-Z0-9]+)\s*-/i);
    if (codeMatch) {
        return codeMatch[1].trim().toUpperCase();
    }
    
    // Handle "Fox Red Extended Novillo Leather" without code
    if (interiorStr.toLowerCase().includes('fox red') && interiorStr.toLowerCase().includes('extended')) {
        return 'NDH2';
    }
    
    // Handle "Fox Red" without code (standard)
    if (interiorStr.toLowerCase().includes('fox red')) {
        return 'NCH2';
    }
    
    // Handle "Rust Brown Extended" without code
    if (interiorStr.toLowerCase().includes('rust brown') && interiorStr.toLowerCase().includes('extended')) {
        return 'ZAP2';
    }
    
    return '';
}

// Load reference data from main.csv embedded reference section
async function loadReferenceData() {
    try {
        const response = await fetch('main.csv');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const csvText = await response.text();
        const lines = csvText.trim().split(/\r?\n/);
        
        let currentSection = '';
        
        for (let i = 0; i < lines.length; i++) {
            const cols = parseCSVLine(lines[i]);
            
            // Detect sections by looking for header rows
            // Paint Code section starts with "Paint Code,Paint Name,RGB Code" in columns 2,3,4
            if (cols[2] === 'Paint Code' && cols[3] === 'Paint Name') {
                currentSection = 'exterior';
                console.log(`Found exterior section at line ${i}`);
                continue;
            }
            
            // Interior section starts with "INTERIOR Code" in column 2
            if (cols[2] === 'INTERIOR Code') {
                currentSection = 'interior';
                console.log(`Found interior section at line ${i}`);
                continue;
            }
            
            // Packages section starts with "Packages" in column 2
            if (cols[2] === 'Packages') {
                currentSection = 'packages';
                console.log(`Found packages section at line ${i}`);
                continue;
            }
            
            // Skip empty rows
            if (cols.every(c => !c || !c.trim())) continue;
            
            // Parse exterior colors - data is in columns 2,3,4,5 (paint code, name, RGB, image URL)
            if (currentSection === 'exterior' && cols[2] && cols[2].trim()) {
                const paintCode = cols[2].trim().toUpperCase();
                // Skip if it's a header or empty
                if (paintCode && paintCode !== 'PAINT CODE' && paintCode.length > 0) {
                    colorLookup[paintCode] = {
                        rgb: cols[4] ? cols[4].trim() : '128,128,128',
                        name: cols[3] ? cols[3].trim() : '',
                        image: cols[5] ? cols[5].trim() : ''
                    };
                    console.log(`Loaded color: ${paintCode} = ${colorLookup[paintCode].name} | Image: ${colorLookup[paintCode].image ? 'Yes' : 'No'}`);
                }
            }
            
            // Parse interior codes - data is in columns 2,3,4,5 (interior code, empty, description, image)
            if (currentSection === 'interior' && cols[2] && cols[2].trim()) {
                const interiorCode = cols[2].trim().toUpperCase();
                // Skip if it's a header
                if (interiorCode && interiorCode !== 'INTERIOR CODE' && interiorCode.length > 0) {
                    interiorLookup[interiorCode] = {
                        image: cols[5] ? cols[5].trim() : '',
                        description: cols[4] ? cols[4].trim() : ''
                    };
                    console.log(`Loaded interior: ${interiorCode} = ${interiorLookup[interiorCode].description}`);
                }
            }
            
            // Parse packages - data is in columns 2,3 (package code, description)
            if (currentSection === 'packages' && cols[2] && cols[2].trim()) {
                const packageCode = cols[2].trim().toUpperCase();
                // Skip headers and empty codes
                if (packageCode && packageCode !== 'PACKAGES' && cols[3]) {
                    let cleanDesc = cols[3].trim();
                    // Clean up the description
                    cleanDesc = cleanDesc.replace(/^["'\s]+|["'\s]+$/g, ''); // Remove quotes and spaces
                    cleanDesc = cleanDesc.replace(/\s+/g, ' '); // Normalize spaces
                    
                    if (cleanDesc && cleanDesc.length > 0) {
                        packageLookup[packageCode] = cleanDesc;
                        console.log(`Loaded package: ${packageCode} = ${cleanDesc.substring(0, 60)}...`);
                    }
                }
            }
        }
        
        console.log(`\n=== REFERENCE DATA LOADED FROM main.csv ===`);
        console.log(`Colors: ${Object.keys(colorLookup).length}`);
        console.log(`Interiors: ${Object.keys(interiorLookup).length}`);
        console.log(`Packages: ${Object.keys(packageLookup).length}`);
        
    } catch (err) {
        console.error('Error loading reference data from main.csv:', err);
    }
    
    // Use defaults if no reference data found
    if (Object.keys(colorLookup).length === 0) {
        Object.assign(colorLookup, defaultColors);
        console.log('Using default color data');
    }
    if (Object.keys(interiorLookup).length === 0) {
        Object.assign(interiorLookup, defaultInteriors);
        console.log('Using default interior data');
    }
    
    console.log(`Final counts - Colors: ${Object.keys(colorLookup).length}, Interiors: ${Object.keys(interiorLookup).length}, Packages: ${Object.keys(packageLookup).length}`);
}

async function loadCSV() {
    // First load reference data
    await loadReferenceData();
    
    try {
        const response = await fetch('main.csv');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const csvText = await response.text();
        const lines = csvText.trim().split(/\r?\n/);
        
        if (!lines.length) {
            throw new Error('CSV file is empty');
        }

        const headers = parseCSVLine(lines[0]);
        const vehicles = [];
        
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
                const cols = parseCSVLine(lines[i]);
                const vin = cols[4] ? cols[4].trim() : '';
                
                // Stop processing after VIN ending in 9194
                if (vin && vin.endsWith('9194')) {
                    if (vin.length > 5) {
                        vehicles.push({
                            exterior: cols[0] || '',
                            interior: cols[2] || '',
                            year: cols[3] || '',
                            vin: vin,
                            model: cols[5] || '',  // Chassis code (C51, C53, etc)
                            packages: cols[7] || '',
                            msrp: cols[9] || '',
                            dealer: cols[13] || '',
                            details: cols[17] || '',
                            vspec: cols[18] || '',
                            sticker: cols[19] || '',
                            invoice: cols[20] || ''
                        });
                    }
                    break; // Stop processing
                }
                
                if (vin && vin.length > 5) {
                    vehicles.push({
                        exterior: cols[0] || '',
                        interior: cols[2] || '',
                        year: cols[3] || '',
                        vin: vin,
                        model: cols[5] || '',  // Chassis code
                        packages: cols[7] || '',
                        msrp: cols[9] || '',
                        dealer: cols[13] || '',
                        details: cols[17] || '',
                        vspec: cols[18] || '',
                        sticker: cols[19] || '',
                        invoice: cols[20] || ''
                    });
                }
            }
        }

        const countEl = document.getElementById('count');
        const totalCountEl = document.getElementById('total-count');
        if (countEl) countEl.textContent = vehicles.length;
        if (totalCountEl) totalCountEl.textContent = vehicles.length;

        const vehiclesWithPackages = vehicles.filter(v => v.packages && v.packages.trim().length > 0).length;
        console.log(`\n=== SUMMARY ===`);
        console.log(`Total vehicles: ${vehicles.length}`);
        console.log(`Vehicles with packages: ${vehiclesWithPackages}`);
        console.log(`PackageLookup entries: ${Object.keys(packageLookup).length}`);

        const table = document.getElementById('table-rows');
        table.innerHTML = '';

        vehicles.forEach((vehicle, index) => {
            const row = document.createElement('div');
            row.className = 'table-row';

            // Extract codes
            const paintCode = extractPaintCode(vehicle.exterior);
            const interiorCode = extractInteriorCode(vehicle.interior);
            
            // Lookup color data
            const colorData = colorLookup[paintCode] || { rgb: '128,128,128', name: 'Unknown' };
            
            // Lookup interior data
            const interiorData = interiorLookup[interiorCode] || { image: '', description: 'Unknown' };
            
            // Lookup exterior image (from reference data if available)
            const exteriorImage = colorData.image || '';
            
            // Determine model code (E90 = Sedan, E92 = Coupe, E93 = Convertible)
            const modelCode = vehicle.model.startsWith('C5') ? 'E90' : 
                             vehicle.model.startsWith('C6') ? 'E92' : 
                             vehicle.model.startsWith('C7') ? 'E93' : 'E90';
            
            // Split and display package codes - handle various spacing
            const packageCodes = vehicle.packages ? 
                vehicle.packages.split(/[,\s]+/).map(p => p.trim()).filter(p => p.length > 0) : 
                [];
            
            // Create display text with codes
            const packageDisplay = packageCodes.length > 0 ? packageCodes.join(', ') : '-';
            
            // Create tooltip details with full descriptions
            const packageDetails = packageCodes.map(code => {
                const codeUpper = code.trim().toUpperCase();
                const pkg = packageLookup[codeUpper];
                if (pkg) {
                    return `<div><strong>${code}:</strong> ${pkg}</div>`;
                } else {
                    return `<div><strong>${code}</strong> (not found in lookup)</div>`;
                }
            }).join('');
            
            // Log vehicles with packages (after variables are declared)
            if (packageCodes.length > 0) {
                console.log(`Vehicle VIN ${vehicle.vin.slice(-6)} has ${packageCodes.length} packages: ${packageCodes.join(', ')}`);
                console.log(`  - packageDisplay: "${packageDisplay}"`);
                console.log(`  - packageDetails length: ${packageDetails.length} chars`);
                console.log(`  - First 100 chars of details: ${packageDetails.substring(0, 100)}`);
            }

            row.innerHTML = `
                <div class="cell cell-checkbox">
                    <input type="checkbox">
                </div>

                <div class="cell cell-status">
                    <div class="status-circle">G</div>
                </div>

                <div class="cell cell-image">
                    ${exteriorImage ? 
                        `<img src="${exteriorImage}" class="exterior-thumbnail" alt="${vehicle.exterior}">` :
                        `<div class="exterior-thumbnail"></div>`
                    }
                </div>

                <div class="cell cell-model">
                    <span class="model-code">${modelCode}</span>
                </div>

                <div class="cell cell-exterior">
                    <div class="tooltip">
                        <div class="color-display">
                            <span class="color-circle" style="background-color: rgb(${colorData.rgb})"></span>
                            <span>${vehicle.exterior}</span>
                        </div>
                        <div class="tooltiptext tooltip-red-content">${vehicle.exterior}<br>RGB: ${colorData.rgb}</div>
                    </div>
                </div>

                <div class="cell cell-interior">
                    <div class="tooltip">
                        <div class="interior-display">
                            ${interiorData.image ? 
                                `<span class="interior-square" style="background-image: url('${interiorData.image}')"></span>` :
                                `<span class="interior-square" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"></span>`
                            }
                            <span>${vehicle.interior}</span>
                        </div>
                        <div class="tooltiptext tooltip-red-content">${vehicle.interior}</div>
                    </div>
                </div>

                <div class="cell cell-year">
                    ${vehicle.year}
                </div>

                <div class="cell cell-vin">
                    <div class="tooltip">
                        <span class="vin-text" id="vin-${index}">${vehicle.vin}</span>
                        <div class="tooltiptext tooltip-red-content">${vehicle.vin}</div>
                    </div>
                    <button class="copy-btn" data-copy-target="vin-${index}" title="Copy VIN">‚ßâ</button>
                </div>

                <div class="cell cell-packages">
                    <div class="tooltip">
                        <span class="packages-short">${packageDisplay}</span>
                        ${packageDetails ? `<div class="tooltiptext tooltip-packages"><strong>Package Details:</strong><br>${packageDetails}</div>` : ''}
                    </div>
                </div>

                <div class="cell cell-msrp">
                    ${vehicle.msrp || '-'}
                </div>

                <div class="cell cell-dealer">
                    <div class="tooltip">
                        <span>${vehicle.dealer || '-'}</span>
                        ${vehicle.dealer ? `<div class="tooltiptext tooltip-red-content">${vehicle.dealer}</div>` : ''}
                    </div>
                </div>
            `;

            table.appendChild(row);
            
            // Add checkbox event listener
            const checkbox = row.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', function() {
                handleCheckboxChange(this, vehicle);
            });
        });

        initCopyButtons();
        applyFilters();

    } catch (err) {
        console.error('Error loading CSV:', err);
        document.getElementById('table-rows').innerHTML = `
            <div style="padding: 40px; text-align: center; color: #dc3545;">
                <h3>‚ö†Ô∏è Error Loading Data</h3>
                <p>${err.message}</p>
                <p>Please ensure main.csv is in the same directory as this HTML file.</p>
            </div>
        `;
    }
}

// Checkbox selection management
let selectedVehicles = new Set();
let vehicleData = []; // Store vehicle data for side panel

function updateSelectionCount() {
    const count = selectedVehicles.size;
    const counter = document.getElementById('selection-count');
    const text = document.getElementById('selection-count-text');
    
    if (count > 0) {
        text.textContent = `${count} Selected`;
        counter.classList.add('visible');
    } else {
        counter.classList.remove('visible');
        closeSidePanel();
    }
}

function handleCheckboxChange(checkbox, vehicleInfo) {
    const row = checkbox.closest('.table-row');
    
    if (checkbox.checked) {
        selectedVehicles.add(vehicleInfo.vin);
        row.classList.add('selected');
        
        // Open side panel with this vehicle
        openSidePanel(vehicleInfo);
    } else {
        selectedVehicles.delete(vehicleInfo.vin);
        row.classList.remove('selected');
    }
    
    updateSelectionCount();
}

function openSidePanel(vehicleInfo) {
    const panel = document.getElementById('side-panel');
    const vehicleName = document.getElementById('panel-vehicle-name');
    const vehicleInfoEl = document.getElementById('panel-vehicle-info');
    
    // Determine model type
    let modelType = 'E90'; // Default
    if (vehicleInfo.model) {
        if (vehicleInfo.model.startsWith('C5')) modelType = 'E90';
        else if (vehicleInfo.model.startsWith('C6')) modelType = 'E92';
        else if (vehicleInfo.model.startsWith('C7')) modelType = 'E93';
    }
    
    // Extract just the color name without the code for cleaner display
    let colorName = vehicleInfo.exterior || 'Unknown';
    // Remove the paint code prefix if present (e.g., "U94 - Fire Orange 2" -> "Fire Orange 2")
    if (colorName.includes(' - ')) {
        colorName = colorName.split(' - ')[1] || colorName;
    }
    
    // Set panel content - simplified format
    vehicleName.textContent = `${modelType} M3`;
    vehicleInfoEl.textContent = `${vehicleInfo.vin || 'Unknown VIN'}`;
    
    // Store current vehicle info for menu actions
    panel.dataset.currentVin = vehicleInfo.vin;
    panel.dataset.currentExterior = vehicleInfo.exterior;
    panel.dataset.currentInterior = vehicleInfo.interior;
    panel.dataset.currentYear = vehicleInfo.year;
    panel.dataset.currentModel = vehicleInfo.model;
    panel.dataset.currentDetails = vehicleInfo.details || '';
    panel.dataset.currentVspec = vehicleInfo.vspec || '';
    panel.dataset.currentSticker = vehicleInfo.sticker || '';
    panel.dataset.currentInvoice = vehicleInfo.invoice || '';
    
    // Open panel
    panel.classList.add('open');
}

function closeSidePanel() {
    const panel = document.getElementById('side-panel');
    panel.classList.remove('open');
}

// Menu action handlers
function handleDetailsClick() {
    const panel = document.getElementById('side-panel');
    const detailsUrl = panel.dataset.currentDetails;
    const vin = panel.dataset.currentVin;
    
    if (!vin) {
        alert('No vehicle selected');
        return;
    }
    
    if (!detailsUrl || detailsUrl.trim() === '') {
        alert(`Details PDF not available for VIN: ${vin}`);
        return;
    }
    
    // Convert GitHub URL to raw content URL if needed
    let pdfUrl = detailsUrl;
    if (pdfUrl.includes('github.com') && !pdfUrl.includes('/raw/')) {
        pdfUrl = pdfUrl.replace('/blob/', '/raw/');
    }
    
    // Open PDF in new tab
    window.open(pdfUrl, '_blank');
}

function handleVSpecClick() {
    const panel = document.getElementById('side-panel');
    const vspecUrl = panel.dataset.currentVspec;
    const vin = panel.dataset.currentVin;
    
    if (!vin) {
        alert('No vehicle selected');
        return;
    }
    
    if (!vspecUrl || vspecUrl.trim() === '') {
        alert(`V-Spec PDF not available for VIN: ${vin}`);
        return;
    }
    
    // Convert GitHub URL to raw content URL if needed
    let pdfUrl = vspecUrl;
    if (pdfUrl.includes('github.com') && !pdfUrl.includes('/raw/')) {
        pdfUrl = pdfUrl.replace('/blob/', '/raw/');
    }
    
    // Open PDF in new tab
    window.open(pdfUrl, '_blank');
}

function handleStickerClick() {
    const panel = document.getElementById('side-panel');
    const stickerUrl = panel.dataset.currentSticker;
    const vin = panel.dataset.currentVin;
    
    if (!vin) {
        alert('No vehicle selected');
        return;
    }
    
    if (!stickerUrl || stickerUrl.trim() === '') {
        alert(`Window Sticker PDF not available for VIN: ${vin}`);
        return;
    }
    
    // Convert GitHub URL to raw content URL if needed
    let pdfUrl = stickerUrl;
    if (pdfUrl.includes('github.com') && !pdfUrl.includes('/raw/')) {
        pdfUrl = pdfUrl.replace('/blob/', '/raw/');
    }
    
    // Open PDF in new tab - browser will display it
    window.open(pdfUrl, '_blank');
}

function handleTradeClick() {
    alert('Trade - Coming soon!');
}

function handleRDRClick() {
    alert('RDR - Coming soon!');
}

function handleDemoClick() {
    alert('Demo - Coming soon!');
}

function handlePreferenceClick() {
    alert('Preference Request - Coming soon!');
}

function handleIncentivesClick() {
    alert('Incentives - Coming soon!');
}

function handleInvoiceClick() {
    const panel = document.getElementById('side-panel');
    const invoiceUrl = panel.dataset.currentInvoice;
    const vin = panel.dataset.currentVin;
    
    if (!vin) {
        alert('No vehicle selected');
        return;
    }
    
    if (!invoiceUrl || invoiceUrl.trim() === '') {
        alert(`Invoice PDF not available for VIN: ${vin}`);
        return;
    }
    
    // Convert GitHub URL to raw content URL if needed
    let pdfUrl = invoiceUrl;
    if (pdfUrl.includes('github.com') && !pdfUrl.includes('/raw/')) {
        pdfUrl = pdfUrl.replace('/blob/', '/raw/');
    }
    
    // Open PDF in new tab - browser will display it
    window.open(pdfUrl, '_blank');
}

function handleAdvPriceClick() {
    alert('Adv. Price - Coming soon!');
}

function handleAccessoriesClick() {
    alert('Accessories - Coming soon!');
}

function handleCustDelChklistClick() {
    alert('Customer Delivery Checklist - Coming soon!');
}

document.addEventListener('DOMContentLoaded', () => {
    setupFilterInputs();
    loadCSV();
});
</script>

</body>
</html>