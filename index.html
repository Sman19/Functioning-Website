<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E9x M3 Inventory</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="app-shell">

    <!-- TOP NAV BAR -->
    <header class="top-nav">
        <div class="top-nav-left">
            <span class="top-nav-home">Home</span>
        </div>
        <div class="top-nav-center">
            <span>E9x M3 U.S</span>
            <span class="divider">|</span>
            <span>U.S Database - 00001</span>
        </div>
        <div class="top-nav-right">
            <span>Public User</span>
            <span class="user-icon">ðŸ‘¤</span>
        </div>
    </header>

    <!-- OWNER / INVENTORY HEADER -->
    <div class="owner-row">
        <div class="owner-pill"></div>
        <div class="owner-labels">
            <span class="owner-main">Owner images</span>
            <span class="owner-sub">E9x M3 Inventory</span>
        </div>
    </div>

    <!-- SUMMARY ROW -->
    <div class="summary-row">
        <div class="summary-left">
            <input type="checkbox" class="summary-checkbox" />
            <span class="summary-text">
                <span id="count">0</span> of 25,672 Vehicle(s)
            </span>
            <span class="badge-m3">M3</span>
        </div>
    </div>

    <!-- GRID -->
    <div class="grid-wrapper">
        <div class="grid-inner">

            <!-- COLUMN LABELS -->
            <div class="column-labels">
                <div class="header-cell header-status">Cat.</div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing">Model Name</div>
                <div class="header-cell header-model">Model</div>
                <div class="header-cell header-color">Ext.</div>
                <div class="header-cell header-interior">Int.</div>
                <div class="header-cell header-year">Yr.</div>
                <div class="header-cell header-vin">VIN</div>
                <div class="header-cell header-packages">Packages</div>
                <div class="header-cell header-price">MSRP</div>
                <div class="header-cell header-dealer">Dealer</div>
            </div>

            <!-- FILTER INPUT ROW -->
            <div class="table-header">
                <div class="header-cell header-status"></div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing">
                    <input class="filter-input" data-field="marketing" />
                </div>
                <div class="header-cell header-model">
                    <input class="filter-input" data-field="model" />
                </div>
                <div class="header-cell header-color">
                    <input class="filter-input" data-field="color" />
                </div>
                <div class="header-cell header-interior">
                    <input class="filter-input" data-field="interior" />
                </div>
                <div class="header-cell header-year">
                    <input class="filter-input" data-field="year" />
                </div>
                <div class="header-cell header-vin">
                    <input class="filter-input" data-field="vin" />
                </div>
                <div class="header-cell header-packages">
                    <input class="filter-input" data-field="packages" />
                </div>
                <div class="header-cell header-price">
                    <input class="filter-input" data-field="price" />
                </div>
                <div class="header-cell header-dealer">
                    <input class="filter-input" data-field="dealer" />
                </div>
            </div>

            <!-- DATA ROWS INJECT HERE -->
            <div id="table-rows"></div>

        </div>
    </div>
</div>

<script>
/*
Expected CSV header (already in your data.csv):

exterior_image,marketing_name,model,chassis,ext_code,ext_rgb,interior_code,interior_image,year,vin,packages
*/

function parseCSVLine(line) {
    // Handles commas inside quotes
    const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
    const matches = line.match(regex) || [];
    return matches.map(v => v.replace(/^"|"$/g, ""));
}

function normalize(text) {
    return (text || "").toLowerCase().trim();
}

async function loadCSV() {
    const res = await fetch("data.csv");
    const text = await res.text();

    const lines = text.trim().split("\n");
    if (lines.length < 2) return;

    // Map columns by HEADER NAME, not by index
    const headerNames = parseCSVLine(lines[0]).map(h => h.trim());
    const rows = lines.slice(1);

    const cars = rows.map(line => {
        const cols = parseCSVLine(line);
        const rowObj = {};
        headerNames.forEach((h, i) => {
            rowObj[h] = cols[i] || "";
        });

        return {
            exterior_image: rowObj.exterior_image || "",
            marketing_name: rowObj.marketing_name || "",
            model: rowObj.model || "",
            chassis: rowObj.chassis || "",
            ext_code: rowObj.ext_code || "",
            ext_rgb: rowObj.ext_rgb || "255,255,255",
            interior_code: rowObj.interior_code || "",
            interior_image: rowObj.interior_image || "",
            year: rowObj.year || "",
            vin: rowObj.vin || "",
            packages: rowObj.packages || "",
            price: "",
            dealer: ""
        };
    });

    document.getElementById("count").textContent = cars.length;

    const container = document.getElementById("table-rows");
    container.innerHTML = "";

    cars.forEach((car, index) => {
        const row = document.createElement("div");
        row.className = "table-row";

        row.innerHTML = `
            <!-- Cat -->
            <div class="cell cell-status">
                <div class="status-circle">G</div>
            </div>

            <!-- Checkbox -->
            <div class="cell cell-checkbox">
                <input type="checkbox" />
            </div>

            <!-- Model name + thumbnail -->
            <div class="cell cell-marketing">
                <div class="tooltip">
                    <div class="marketing-name"
                         style="background-image:url('${car.exterior_image}')">
                        <span>${car.marketing_name || "M3 Sedan"}</span>
                    </div>
                    <div class="tooltiptext tooltip-red-content">
                        ${car.marketing_name || "M3 Sedan"}
                    </div>
                </div>
            </div>

            <!-- Model / chassis -->
            <div class="cell cell-model">
                ${car.chassis || car.model}
            </div>

            <!-- Exterior color (RGB only for the circle, ext_code as text) -->
            <div class="cell cell-color">
                <div class="tooltip">
                    <div class="color-cell">
                        <span class="circle"
                              style="background-color: rgb(${car.ext_rgb});"></span>
                        <div class="label">${car.ext_code}</div>
                    </div>
                    <div class="tooltiptext tooltip-red-content">
                        ${car.ext_code}
                    </div>
                </div>
            </div>

            <!-- Interior color (image only, no URL text) -->
            <div class="cell cell-interior">
                <div class="tooltip">
                    <div class="color-cell">
                        <span class="square"
                              style="background-image:url('${car.interior_image}');"></span>
                        <div class="label">${car.interior_code}</div>
                    </div>
                    <div class="tooltiptext tooltip-red-content">
                        ${car.interior_code}
                    </div>
                </div>
            </div>

            <!-- Year -->
            <div class="cell cell-year">
                ${car.year}
            </div>

            <!-- VIN + copy button -->
            <div class="cell cell-vin">
                <div class="tooltip">
                    <span class="vin-text" id="vin-${index}">${car.vin}</span>
                    <div class="tooltiptext tooltip-red-content">
                        ${car.vin}
                    </div>
                </div>
                <button class="copy-btn" data-copy-target="vin-${index}">â§‰</button>
            </div>

            <!-- Packages (codes only for now) -->
            <div class="cell cell-packages">
                ${car.packages}
            </div>

            <!-- MSRP (blank for now) -->
            <div class="cell cell-price">
                ${car.price}
            </div>

            <!-- Dealer (blank for now) -->
            <div class="cell cell-dealer">
                ${car.dealer}
            </div>
        `;

        container.appendChild(row);
    });

    initFilters();
    initCopyButtons();
}

function initFilters() {
    const fieldSelectors = {
        marketing: ".cell-marketing",
        model: ".cell-model",
        color: ".cell-color",
        interior: ".cell-interior",
        year: ".cell-year",
        vin: ".cell-vin",
        packages: ".cell-packages",
        price: ".cell-price",
        dealer: ".cell-dealer"
    };

    const inputs = document.querySelectorAll(".filter-input");

    function applyFilters() {
        const filters = {};
        inputs.forEach(input => {
            const field = input.dataset.field;
            const value = normalize(input.value);
            if (value) filters[field] = value;
        });

        const rows = document.querySelectorAll(".table-row");
        rows.forEach(row => {
            let visible = true;
            for (const field in filters) {
                const cell = row.querySelector(fieldSelectors[field]);
                const text = cell ? normalize(cell.innerText) : "";
                if (!text.includes(filters[field])) {
                    visible = false;
                    break;
                }
            }
            row.style.display = visible ? "flex" : "none";
        });
    }

    inputs.forEach(input => {
        input.addEventListener("keydown", e => {
            if (e.key === "Enter") applyFilters();
        });
    });
}

function initCopyButtons() {
    document.querySelectorAll(".copy-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.copyTarget;
            const el = document.getElementById(id);
            if (!el) return;
            const txt = el.textContent.trim();
            navigator.clipboard.writeText(txt).then(() => {
                btn.classList.add("copied");
                setTimeout(() => btn.classList.remove("copied"), 600);
            });
        });
    });
}

window.addEventListener("DOMContentLoaded", loadCSV);
</script>
</body>
</html>
