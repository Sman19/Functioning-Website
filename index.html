<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E9x M3 Database</title>

<!-- AuthPro login protection -->
<script 
    type="text/javascript" 
    src="https://www.authpro.com/auth/sman201/?action=pp&no_redirect=1&get_profile=1">
</script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #ffffff;
    font-size: 13px;
}

.app-shell {
    width: 100%;
}

/* LOGIN PORTAL */
.login-wrapper {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #111827;
    color: #f9fafb;
    padding: 16px;
    box-sizing: border-box;
}

.login-box {
    background: #1f2937;
    padding: 24px 32px;
    border-radius: 12px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

.login-title {
    font-size: 20px;
    margin-bottom: 8px;
}

.login-subtitle {
    font-size: 13px;
    color: #9ca3af;
    margin-bottom: 16px;
}

.logout-link {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #e5e7eb;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: #111827;
    text-decoration: none;
    display: none;
}

/* TOP NAV */
.top-nav {
    height: 64px;
    background: #3b3f46;
    color: #ffffff;
    display: flex;
    align-items: center;
    padding: 0 32px;
}

.top-nav-left, .top-nav-center, .top-nav-right {
    display: flex;
    align-items: center;
}

.top-nav-left { flex: 1; }
.top-nav-center { flex: 2; justify-content: center; gap: 8px; font-size: 16px; }
.top-nav-right { flex: 1; justify-content: flex-end; gap: 8px; }

.top-nav-home { font-size: 16px; }
.user-icon { font-size: 18px; }
.top-nav .divider { opacity: 0.7; }

/* OWNER ROW */
.owner-row {
    display: flex;
    align-items: center;
    padding: 20px 32px 8px;
    gap: 12px;
}

.owner-pill {
    width: 6px;
    height: 40px;
    border-radius: 999px;
    background: #e11d21;
}

.owner-labels { display: flex; flex-direction: column; gap: 2px; }
.owner-main { font-size: 22px; }
.owner-sub { font-size: 22px; color: #e11d21; }

/* SUMMARY ROW */
.summary-row {
    padding: 8px 32px;
    border-bottom: 1px solid #e5e7eb;
}

.summary-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.badge-m3 {
    background: #007bff;
    color: #ffffff;
    padding: 2px 10px;
    border-radius: 4px;
    font-size: 14px;
}

/* GRID */
.grid-wrapper { width: 100%; overflow-x: auto; }
.grid-inner { min-width: 1800px; }

/* COLUMN LABELS */
.column-labels {
    display: flex;
    align-items: stretch;
    background: #f3f4f6;
    padding: 10px 8px 4px;
    border-bottom: 1px solid #d1d5db;
}

.header-cell {
    padding: 0 4px;
    display: flex;
    align-items: center;
    flex: 0 0 auto;
    font-weight: 600;
    color: #4b5563;
    font-size: 14px;
}

.header-checkbox { width: 40px; }
.header-status { width: 40px; }
.header-image { width: 100px; }
.header-model { width: 60px; }
.header-exterior { width: 220px; }
.header-interior { width: 220px; }
.header-year { width: 70px; }
.header-vin { width: 200px; }
.header-packages { width: 400px; }
.header-msrp { width: 120px; }
.header-dealer { width: 240px; }

/* FILTER ROW */
.table-header {
    display: flex;
    align-items: center;
    background: #eceff1;
    padding: 4px 8px;
    border-bottom: 1px solid #d1d5db;
}

.filter-input {
    width: 100%;
    padding: 4px 6px;
    border-radius: 4px;
    border: 1px solid #d1d5db;
    font-size: 13px;
}

/* TABLE ROWS */
.table-row {
    display: flex;
    align-items: center;
    padding: 12px 8px;
    border-bottom: 1px solid #ddd;
    min-height: 50px;
    background: #f3f4f6;
}
.table-row:nth-child(even) { background: #eceff1; }

.cell { padding: 0 4px; display: flex; align-items: center; flex: 0 0 auto; }

/* COLOR CIRCLE */
.color-circle {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid #999;
}

/* INTERIOR IMAGE */
.interior-square {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    background-size: cover;
    background-position: center;
    border: 1px solid #999;
}

/* VIN */
.vin-text {
    font-family: ui-monospace;
    font-size: 13px;
}

/* PACKAGES */
.packages-short {
    max-width: 380px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* SELECTION */
.selection-count {
    position: fixed;
    top: 72px;
    right: 20px;
    background: white;
    padding: 8px 16px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
}
.selection-count.visible { display: block; }

/* SIDE PANEL */
.side-panel {
    position: fixed;
    right: -400px;
    top: 64px;
    width: 400px;
    height: calc(100vh - 64px);
    background: white;
    box-shadow: -2px 0 8px rgba(0,0,0,0.15);
    transition: right 0.3s ease;
    overflow-y: auto;
}
.side-panel.open { right: 0; }

.side-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    background: white;
}

/* END CSS */
</style>
</head>

<body>

<!-- LOGOUT BUTTON -->
<a href="https://www.authpro.com/auth/sman201/?action=logout" 
   class="logout-link" 
   id="logout-link">Logout</a>

<!-- LOGIN PORTAL -->
<div id="login-portal" class="login-wrapper">
    <div class="login-box">
        <div class="login-title">E9x M3 Database</div>
        <div class="login-subtitle">Please log in to continue.</div>
        <p style="font-size:13px;color:#d1d5db;margin-top:12px;">
            After login, you will return here automatically.
        </p>
    </div>
</div>

<!-- MAIN APP (hidden until login) -->
<div class="app-shell" id="app-shell" style="display:none;">
    <!-- TOP NAV BAR -->
    <header class="top-nav">
        <div class="top-nav-left">
            <span class="top-nav-home">Home</span>
        </div>
        <div class="top-nav-center">
            <span>E9x M3 U.S</span>
            <span class="divider">|</span>
            <span>U.S Database - 00001</span>
        </div>
        <div class="top-nav-right">
            <span>Public User</span>
            <span class="user-icon">üë§</span>
        </div>
    </header>

    <!-- OWNER HEADER -->
    <div class="owner-row">
        <div class="owner-pill"></div>
        <div class="owner-labels">
            <span class="owner-main">Owner images</span>
            <span class="owner-sub">E9x M3 Inventory</span>
        </div>
    </div>

    <!-- SUMMARY ROW -->
    <div class="summary-row">
        <div class="summary-left">
            <input type="checkbox" class="summary-checkbox">
            <span class="summary-text">
                <span id="count">0</span> of <span id="total-count">0</span> Vehicle(s)
            </span>
            <span class="badge-m3">M3</span>
        </div>
    </div>

    <!-- GRID WRAPPER -->
    <div class="grid-wrapper">
        <div class="grid-inner">

            <!-- COLUMN LABELS -->
            <div class="column-labels">
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-status">Cat.</div>
                <div class="header-cell header-image">Image</div>
                <div class="header-cell header-model">Model</div>
                <div class="header-cell header-exterior">Exterior</div>
                <div class="header-cell header-interior">Interior</div>
                <div class="header-cell header-year">Year</div>
                <div class="header-cell header-vin">VIN</div>
                <div class="header-cell header-packages">
                    Packages (Destination Charge: $875 | Gas Guzzler Tax: $1,300)
                </div>
                <div class="header-cell header-msrp">MSRP</div>
                <div class="header-cell header-dealer">Dealer Name</div>
            </div>

            <!-- FILTER ROW -->
            <div class="table-header">
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-status"></div>
                <div class="header-cell header-image"></div>

                <div class="header-cell header-model">
                    <input class="filter-input" data-field="model" placeholder="Filter...">
                </div>

                <div class="header-cell header-exterior">
                    <input class="filter-input" data-field="exterior" placeholder="Filter...">
                </div>

                <div class="header-cell header-interior">
                    <input class="filter-input" data-field="interior" placeholder="Filter...">
                </div>

                <div class="header-cell header-year">
                    <input class="filter-input" data-field="year" placeholder="Filter...">
                </div>

                <div class="header-cell header-vin">
                    <input class="filter-input" data-field="vin" placeholder="Filter...">
                </div>

                <div class="header-cell header-packages">
                    <input class="filter-input" data-field="packages" placeholder="Filter...">
                </div>

                <div class="header-cell header-msrp">
                    <input class="filter-input" data-field="msrp" placeholder="Filter...">
                </div>

                <div class="header-cell header-dealer">
                    <input class="filter-input" data-field="dealer" placeholder="Filter...">
                </div>
            </div>

            <!-- TABLE ROWS -->
            <div id="table-rows">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading vehicle data...</div>
                </div>
            </div>

        </div>
    </div>

</div> <!-- END OF APP -->

<!-- SELECTION COUNTER -->
<div class="selection-count" id="selection-count">
    <span id="selection-count-text">0 Selected</span>
</div>

<!-- SIDE PANEL -->
<div class="side-panel" id="side-panel">
    <div class="side-panel-header">
        <div class="side-panel-header-top">
            <div class="side-panel-title">1 Selected</div>
            <button class="side-panel-close" onclick="closeSidePanel()">‚úï</button>
        </div>
        <div class="side-panel-vehicle-name" id="panel-vehicle-name">-</div>
        <div class="side-panel-vehicle-info" id="panel-vehicle-info">-</div>
    </div>

    <div class="side-panel-divider">
        <span class="side-panel-divider-arrow">‚ñº</span>
    </div>

    <div class="side-panel-menu">
        <div class="side-panel-menu-grid">

            <div class="side-panel-menu-item" onclick="handleDetailsClick()">
                <span class="side-panel-menu-icon">‚ò∞</span>
                <span class="side-panel-menu-text">Details</span>
            </div>

            <div class="side-panel-menu-item" onclick="handleVSpecClick()">
                <span class="side-panel-menu-icon">üìã</span>
                <span class="side-panel-menu-text">V-Spec</span>
            </div>

            <div class="side-panel-menu-item" onclick="handleStickerClick()">
                <span class="side-panel-menu-icon">üè∑Ô∏è</span>
                <span class="side-panel-menu-text">Sticker</span>
            </div>

            <div class="side-panel-menu-item" onclick="handleInvoiceClick()">
                <span class="side-panel-menu-icon">üìÑ</span>
                <span class="side-panel-menu-text">Invoice</span>
            </div>

        </div>
    </div>
</div>
<script>
// ------------------------------
// AUTH / LOGIN FUNCTIONS
// ------------------------------

// AuthPro sometimes loads variables AFTER the page renders.
// It also ALWAYS sets the cookie: ap_sman201=xxxxx
// We detect login using BOTH methods.

// Check cookie (always reliable)
function isLoggedInByCookie() {
    return document.cookie.includes("ap_sman201=");
}

// Check AuthPro JS variables
function isLoggedInByVariables() {
    return (typeof auth_res !== "undefined" && auth_res === "ok");
}

// Combined check
function userIsLoggedIn() {
    return isLoggedInByVariables() || isLoggedInByCookie();
}

// Show/hide login + app
function toggleAppVisibility() {
    const loggedIn = userIsLoggedIn();
    const portal = document.getElementById("login-portal");
    const app = document.getElementById("app-shell");
    const logoutBtn = document.getElementById("logout-link");

    if (loggedIn) {
        portal.style.display = "none";
        app.style.display = "block";
        logoutBtn.style.display = "block";
        return true;
    } else {
        portal.style.display = "flex";
        app.style.display = "none";
        logoutBtn.style.display = "none";
        return false;
    }
}

// ------------------------------
// RETRY LOOP (fixes login not loading database immediately)
// ------------------------------

function startLoginRetryAndInit() {
    let attempts = 0;

    function check() {
        attempts++;

        if (toggleAppVisibility()) {
            // Now safe to load app data
            setupFilterInputs();
            loadCSV();
            return;
        }

        // Retry for 2 seconds (~12 attempts)
        if (attempts < 12) {
            setTimeout(check, 150);
        }
    }

    // Begin detection loop
    setTimeout(check, 150);
}

document.addEventListener("DOMContentLoaded", startLoginRetryAndInit);



// ========================================================================
// ========================  DATA SYSTEM BEGIN  ===========================
// ========================================================================

// Lookup storage
const colorLookup = {};
const interiorLookup = {};
const packageLookup = {};

// DEFAULT COLORS
const defaultColors = {
    '300': { rgb: '255,255,255', name: 'Alpine White', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/88d5599e9c5abc6da52cfffe7488fc47056127ac/Alpine%20White%20-%20E90%20.png?raw=true' },
    '668': { rgb: '0,0,0', name: 'Jet Black', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/184a291efe57013d3e0607390ab5a2eb6bde6a2b/jet%20black%20-%20E90.png?raw=true' },
    'A29': { rgb: '205,223,244', name: 'Silverstone Metallic II', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Silverstone%20-%20E90.png?raw=true' },
    'A30': { rgb: '30,53,138', name: 'Interlogos Blue Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Interlogos%20Blue%20Metallic%20-%20E90.png?raw=true' },
    'A52': { rgb: '102,109,127', name: 'Space Gray Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/9fd94093c78555c094f7399c638ce1736e2e8a88/Space%20Gray%20Metallic%20-%20E90.png?raw=true' },
    'A73': { rgb: '39,41,56', name: 'Jerez Black Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Jerez%20black%20Metallic%20-%20E90.png?raw=true' },
    'A75': { rgb: '240,0,0', name: 'Melbourne Red Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/Melborune%20Red%20Metallic%20-%20E90.png?raw=true' },
    '381': { rgb: '17,93,176', name: 'Le Mans Blue Metallic', image: 'https://github.com/Sman19/E90-ext.380x260px/blob/c64544c1c445627d52ef9aebb7b49748cac3807c/LE%20Mans%20blue%20metallic%20-%20E90.png?raw=true' }
};

// DEFAULT INTERIORS
const defaultInteriors = {
    'NCSW': { image: 'https://github.com/Sman19/E9x-Interiors/.../Black.png', description: 'Black Novillo Leather' },
    'NCH2': { image: 'https://github.com/Sman19/E9x-Interiors/.../Fox.png', description: 'Fox Red Novillo Leather' },
    // Add your existing defaults here...
};


// ===============================
// FILTER UTILITIES
// ===============================

function normalize(t) {
    return (t || "").toLowerCase().trim();
}

function debounce(fn, wait) {
    let t;
    return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
    };
}

function setupFilterInputs() {
    const debounced = debounce(applyFilters, 200);
    document.querySelectorAll(".filter-input").forEach(inp => {
        inp.addEventListener("input", debounced);
    });
}

function applyFilters() {
    const rows = document.querySelectorAll("#table-rows .table-row");
    const inputs = document.querySelectorAll(".filter-input");

    const filters = {};
    inputs.forEach(inp => {
        const f = inp.dataset.field;
        const v = normalize(inp.value);
        if (v) filters[f] = v;
    });

    let visible = 0;

    rows.forEach(row => {
        let show = true;

        for (const field in filters) {
            const cell = row.querySelector(".cell-" + field);
            const text = normalize(cell ? cell.innerText : "");
            if (!text.includes(filters[field])) {
                show = false;
                break;
            }
        }

        row.style.display = show ? "flex" : "none";
        if (show) visible++;
    });

    document.getElementById("count").textContent = visible;
}



// ===============================
// CSV PARSER
// ===============================

function parseCSVLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const c = line[i];
        const n = line[i + 1];

        if (c === '"') {
            if (inQuotes && n === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (c === "," && !inQuotes) {
            result.push(current.trim());
            current = "";
        } else {
            current += c;
        }
    }
    result.push(current.trim());
    return result;
}



// ===============================
// EXTRACTORS
// ===============================

function extractPaintCode(str) {
    if (!str) return "";
    const match = str.match(/^([A-Z0-9]+)\s*-/);
    return match ? match[1].toUpperCase() : "";
}

function extractInteriorCode(str) {
    if (!str) return "";
    const match = str.match(/^([A-Z0-9]+)\s*-/);
    return match ? match[1].toUpperCase() : "";
}



// ===============================
// LOAD main.csv (database file)
// ===============================

async function loadCSV() {
    console.log("Loading CSV...");

    let response;
    try {
        response = await fetch("main.csv");
    } catch (e) {
        console.error("Fetch error:", e);
        return;
    }

    if (!response.ok) {
        console.error("CSV HTTP error:", response.status);
        return;
    }

    const text = await response.text();
    const lines = text.trim().split(/\r?\n/);
    const rows = [];

    // Skip header
    for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (!cols.length) continue;

        rows.push({
            exterior: cols[0],
            interior: cols[2],
            year: cols[3],
            vin: cols[4],
            model: cols[5],
            packages: cols[7],
            msrp: cols[9],
            dealer: cols[13],
            details: cols[17],
            vspec: cols[18],
            sticker: cols[19],
            invoice: cols[20]
        });
    }

    buildTable(rows);
}



// ===============================
// BUILD TABLE
// ===============================

function buildTable(data) {
    const table = document.getElementById("table-rows");
    table.innerHTML = "";

    document.getElementById("count").textContent = data.length;
    document.getElementById("total-count").textContent = data.length;

    data.forEach((v, idx) => {
        const row = document.createElement("div");
        row.className = "table-row";

        const paint = extractPaintCode(v.exterior);
        const interior = extractInteriorCode(v.interior);

        const colorData = colorLookup[paint] || defaultColors[paint] || {rgb:"128,128,128", image:""};
        const interiorData = interiorLookup[interior] || defaultInteriors[interior] || {image:""};

        row.innerHTML = `
            <div class="cell cell-checkbox"><input type="checkbox"></div>
            <div class="cell cell-status"><div class="status-circle">G</div></div>
            <div class="cell cell-image">
                <img src="${colorData.image || ""}" class="exterior-thumbnail">
            </div>
            <div class="cell cell-model">${v.model}</div>
            <div class="cell cell-exterior">${v.exterior}</div>
            <div class="cell cell-interior">${v.interior}</div>
            <div class="cell cell-year">${v.year}</div>

            <div class="cell cell-vin">
                <span class="vin-text">${v.vin}</span>
            </div>

            <div class="cell cell-packages">${v.packages}</div>
            <div class="cell cell-msrp">${v.msrp}</div>
            <div class="cell cell-dealer">${v.dealer}</div>
        `;

        // Checkbox behavior
        row.querySelector("input[type=checkbox]").addEventListener("change", function () {
            handleCheckboxChange(this, v);
        });

        table.appendChild(row);
    });
}



// ===============================
// SELECTION LOGIC
// ===============================

let selectedVehicles = new Set();

function updateSelectionCount() {
    const count = selectedVehicles.size;
    const el = document.getElementById("selection-count");

    if (count > 0) {
        el.classList.add("visible");
        document.getElementById("selection-count-text").textContent = count + " Selected";
    } else {
        el.classList.remove("visible");
        closeSidePanel();
    }
}

function handleCheckboxChange(checkbox, vehicle) {
    const row = checkbox.closest(".table-row");

    if (checkbox.checked) {
        selectedVehicles.add(vehicle.vin);
        row.classList.add("selected");
        openSidePanel(vehicle);
    } else {
        selectedVehicles.delete(vehicle.vin);
        row.classList.remove("selected");
    }

    updateSelectionCount();
}



// ===============================
// SIDE PANEL
// ===============================

function openSidePanel(v) {
    const p = document.getElementById("side-panel");
    document.getElementById("panel-vehicle-name").textContent = v.model + " M3";
    document.getElementById("panel-vehicle-info").textContent = v.vin;

    p.dataset.details = v.details;
    p.dataset.vspec = v.vspec;
    p.dataset.sticker = v.sticker;
    p.dataset.invoice = v.invoice;

    p.classList.add("open");
}

function closeSidePanel() {
    document.getElementById("side-panel").classList.remove("open");
}



// ===============================
// PANEL MENU ACTIONS
// ===============================

function fixGithubLink(url) {
    if (!url) return "";
    if (url.includes("github.com") && !url.includes("/raw/")) {
        return url.replace("/blob/", "/raw/");
    }
    return url;
}

function handleDetailsClick() {
    openPDF("details");
}
function handleVSpecClick() {
    openPDF("vspec");
}
function handleStickerClick() {
    openPDF("sticker");
}
function handleInvoiceClick() {
    openPDF("invoice");
}

function openPDF(type) {
    const panel = document.getElementById("side-panel");
    const url = panel.dataset[type];

    if (!url) {
        alert(type.toUpperCase() + " PDF not available.");
        return;
    }
    window.open(fixGithubLink(url), "_blank");
}

</script>

</body>
</html>
