<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E9x M3 U.S | Inventory</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="app-shell">

    <!-- TOP NAV BAR -->
    <header class="top-nav">
        <div class="top-nav-left">
            <span class="top-nav-home">Home</span>
        </div>
        <div class="top-nav-center">
            <span>E9x M3 U.S</span>
            <span class="divider">|</span>
            <span>U.S Database - 00001</span>
        </div>
        <div class="top-nav-right">
            <span>Public User</span>
            <span class="user-icon">ðŸ‘¤</span>
        </div>
    </header>

    <!-- OWNER / INVENTORY HEADER -->
    <div class="owner-row">
        <div class="owner-pill"></div>
        <div class="owner-labels">
            <span class="owner-main">Owner images</span>
            <span class="owner-sub">E9x M3 Inventory</span>
        </div>
    </div>

    <!-- SUMMARY ROW -->
    <div class="summary-row">
        <div class="summary-left">
            <input type="checkbox" class="summary-checkbox">
            <span class="summary-text">
                <span id="vehicle-count">0</span> of 25,672 Vehicle(s)
            </span>
            <span class="badge-m3">M3</span>
        </div>
    </div>

    <!-- GRID -->
    <div class="grid-wrapper">
        <div class="grid-inner">

            <!-- COLUMN LABELS (BMW-style) -->
            <div class="column-labels">
                <div class="header-cell header-status">Cat.</div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing">Model Name</div>
                <div class="header-cell header-model">Model</div>
                <div class="header-cell header-color">Ext.</div>
                <div class="header-cell header-interior">Int.</div>
                <div class="header-cell header-year">Yr.</div>
                <div class="header-cell header-vin">VIN</div>
                <div class="header-cell header-packages">
                    Accessories (Individual Paint<br>
                    Charge - $5,000*)
                </div>
                <div class="header-cell header-price">
                    MSRP (Includes<br>
                    Gas Guzzler<br>
                    and Destination<br>
                    Charges)
                </div>
                <div class="header-cell header-dealer">
                    Dealer Name (PC -<br>
                    Center | E.D - Euro<br>
                    Military)
                </div>
            </div>

            <!-- FILTER ROW -->
            <div class="table-header">
                <div class="header-cell header-status"></div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing">
                    <input class="filter-input" data-field="marketing">
                </div>
                <div class="header-cell header-model">
                    <input class="filter-input" data-field="model">
                </div>
                <div class="header-cell header-color">
                    <input class="filter-input" data-field="color">
                </div>
                <div class="header-cell header-interior">
                    <input class="filter-input" data-field="interior">
                </div>
                <div class="header-cell header-year">
                    <input class="filter-input" data-field="year">
                </div>
                <div class="header-cell header-vin">
                    <input class="filter-input" data-field="vin">
                </div>
                <div class="header-cell header-packages">
                    <input class="filter-input" data-field="packages">
                </div>
                <div class="header-cell header-price">
                    <input class="filter-input" data-field="price">
                </div>
                <div class="header-cell header-dealer">
                    <input class="filter-input" data-field="dealer">
                </div>
            </div>

            <!-- ALL ROWS FROM data.csv GO HERE -->
            <div id="data-rows"></div>

        </div>
    </div>
</div>

<!-- CSV + RENDER SCRIPT -->
<script>
/**
 * Parse one CSV line into an array, handling quoted fields.
 */
function parseCsvLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"' ) {
            // toggle quoted state or handle escaped quote
            if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (ch === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += ch;
        }
    }
    result.push(current);
    return result;
}

/**
 * Load CSV and build rows that match the BMW-style line.
 */
async function loadCSV() {
    const res = await fetch('data.csv');
    const text = await res.text();

    const lines = text.trim().split('\n');
    if (!lines.length) return;

    // Header row â†’ property names
    const headerCells = parseCsvLine(lines[0]).map(h => h.trim());
    const rows = lines.slice(1);

    const data = rows.map(line => {
        const cells = parseCsvLine(line);
        const obj = {};
        headerCells.forEach((h, idx) => {
            obj[h] = (cells[idx] || '').replace(/^"|"$/g, '');
        });
        return obj;
    });

    // Update â€œx of 25,672 Vehicle(s)â€
    document.getElementById('vehicle-count').textContent = data.length;

    const container = document.getElementById('data-rows');
    container.innerHTML = '';

    data.forEach((v, index) => {
        // fallbacks so we don't show "undefined"
        const exteriorImage  = v.exterior_image || '';
        const marketingName  = v.marketing_name || 'M3 Sedan';
        const model          = v.chassis || v.model || 'E90';
        const extCode        = v.ext_code || '';
        const extRgb         = v.ext_rgb || '';
        const interiorCode   = v.interior_code || '';
        const interiorImage  = v.interior_image || '';
        const year           = v.year || '';
        const vin            = v.vin || '';
        const packages       = v.packages || '';
        const price          = v.price || '';
        const dealer         = v.dealer || '';

        const row = document.createElement('div');
        row.className = 'table-row';

        row.innerHTML = `
            <!-- Cat / status -->
            <div class="cell cell-status">
                <div class="status-circle">G</div>
            </div>

            <!-- Checkbox -->
            <div class="cell cell-checkbox">
                <input type="checkbox">
            </div>

            <!-- Model name + exterior image -->
            <div class="cell cell-marketing">
                <div class="tooltip">
                    <div class="marketing-name"
                         style="background-image:url('${exteriorImage}')">
                        <span>${marketingName}</span>
                    </div>
                    <div class="tooltiptext tooltip-red-content">
                        ${marketingName}
                    </div>
                </div>
            </div>

            <!-- Model code -->
            <div class="cell cell-model">${model}</div>

            <!-- Exterior swatch (RGB circle + code) -->
            <div class="cell cell-color">
                <div class="color-cell">
                    <span class="circle"
                          style="${extRgb ? `background-color: rgb(${extRgb});` : ''}"></span>
                    <div class="label">${extCode}</div>
                </div>
            </div>

            <!-- Interior swatch (image square + code) -->
            <div class="cell cell-interior">
                <div class="color-cell">
                    <span class="square"
                          style="${interiorImage ? `background-image:url('${interiorImage}')` : ''}"></span>
                    <div class="label">${interiorCode}</div>
                </div>
            </div>

            <!-- Year -->
            <div class="cell cell-year">${year}</div>

            <!-- VIN pill + copy button -->
            <div class="cell cell-vin">
                <div class="tooltip">
                    <span class="vin-text" id="vin-${index}">${vin}</span>
                    <div class="tooltiptext tooltip-red-content">
                        ${vin}
                    </div>
                </div>
                <button class="copy-btn" data-copy-target="vin-${index}">â§‰</button>
            </div>

            <!-- Packages (keep text only for now) -->
            <div class="cell cell-packages">
                ${packages}
            </div>

            <!-- MSRP (empty for now) -->
            <div class="cell cell-price">
                ${price}
            </div>

            <!-- Dealer (empty for now) -->
            <div class="cell cell-dealer">
                ${dealer}
            </div>
        `;

        container.appendChild(row);
    });

    initFilters();
    initCopyButtons();
}

/**
 * Filter logic (Enter to apply).
 */
function initFilters() {
    const fieldSelectors = {
        marketing: '.cell-marketing',
        model: '.cell-model',
        color: '.cell-color',
        interior: '.cell-interior',
        year: '.cell-year',
        vin: '.cell-vin',
        packages: '.cell-packages',
        price: '.cell-price',
        dealer: '.cell-dealer'
    };

    function normalize(text) {
        return (text || '').toLowerCase().trim();
    }

    function applyFilters() {
        const rows = document.querySelectorAll('.table-row');
        const inputs = document.querySelectorAll('.filter-input');

        const filters = {};
        inputs.forEach(input => {
            const field = input.dataset.field;
            const value = normalize(input.value);
            if (value) filters[field] = value;
        });

        rows.forEach(row => {
            let visible = true;
            for (const field in filters) {
                const cell = row.querySelector(fieldSelectors[field]);
                const cellText = normalize(cell ? cell.innerText : '');
                if (!cellText.includes(filters[field])) {
                    visible = false;
                    break;
                }
            }
            row.style.display = visible ? 'flex' : 'none';
        });
    }

    document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') applyFilters();
        });
    });
}

/**
 * Copy-VIN buttons.
 */
function initCopyButtons() {
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.copyTarget;
            const el = document.getElementById(id);
            if (!el) return;
            const text = el.textContent.trim();
            navigator.clipboard.writeText(text).then(() => {
                btn.classList.add('copied');
                setTimeout(() => btn.classList.remove('copied'), 600);
            });
        });
    });
}

// kick everything off
loadCSV();
</script>

</body>
</html>
