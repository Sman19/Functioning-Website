<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index.html</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-shell">

    <!-- TOP NAV BAR -->
    <header class="top-nav">
        <div class="top-nav-left">
            <span class="top-nav-home">Home</span>
        </div>
        <div class="top-nav-center">
            <span>E9x M3 U.S</span>
            <span class="divider">|</span>
            <span>U.S Database - 00001</span>
        </div>
        <div class="top-nav-right">
            <span>Public User</span>
            <span class="user-icon">ðŸ‘¤</span>
        </div>
    </header>

    <!-- OWNER / INVENTORY HEADER -->
    <div class="owner-row">
        <div class="owner-pill"></div>
        <div class="owner-labels">
            <span class="owner-main">Owner images</span>
            <span class="owner-sub">E9x M3 Inventory</span>
        </div>
    </div>

    <!-- SUMMARY ROW -->
    <div class="summary-row">
        <div class="summary-left">
            <input type="checkbox" class="summary-checkbox">
            <span class="summary-text">
                <span id="count">0</span> of 25,672 Vehicle(s)
            </span>
            <span class="badge-m3">M3</span>
        </div>
    </div>

    <!-- GRID -->
    <div class="grid-wrapper">
        <div class="grid-inner">

            <!-- COLUMN LABELS -->
            <div class="column-labels">
                <div class="header-cell header-status">Cat.</div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing">Model Name</div>
                <div class="header-cell header-model">Model</div>
                <div class="header-cell header-color">Ext.</div>
                <div class="header-cell header-interior">Int.</div>
                <div class="header-cell header-year">Yr.</div>
                <div class="header-cell header-vin">VIN</div>
                <div class="header-cell header-packages">
                    Accessories (Individual Paint<br>
                    Charge - $5,000*)
                </div>
                <div class="header-cell header-price">
                    MSRP (Includes<br>
                    Gas Guzzler<br>
                    and Destination<br>
                    Charges)
                </div>
                <div class="header-cell header-dealer">
                    Dealer Name (PC -<br>
                    Center | E.D - Euro<br>
                    Military)
                </div>
            </div>

            <!-- FILTER INPUT ROW -->
            <div class="table-header">
                <div class="header-cell header-status"></div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing">
                    <input class="filter-input" data-field="marketing" placeholder="">
                </div>
                <div class="header-cell header-model">
                    <input class="filter-input" data-field="model" placeholder="">
                </div>
                <div class="header-cell header-color">
                    <input class="filter-input" data-field="color" placeholder="">
                </div>
                <div class="header-cell header-interior">
                    <input class="filter-input" data-field="interior" placeholder="">
                </div>
                <div class="header-cell header-year">
                    <input class="filter-input" data-field="year" placeholder="">
                </div>
                <div class="header-cell header-vin">
                    <input class="filter-input" data-field="vin" placeholder="">
                </div>
                <div class="header-cell header-packages">
                    <input class="filter-input" data-field="packages" placeholder="">
                </div>
                <div class="header-cell header-price">
                    <input class="filter-input" data-field="price" placeholder="">
                </div>
                <div class="header-cell header-dealer">
                    <input class="filter-input" data-field="dealer" placeholder="">
                </div>
            </div>

            <!-- DATA ROWS INJECTED HERE -->
            <div id="table-rows"></div>

        </div>
    </div>
</div>

<!-- SCRIPT: LOAD CSV + BUILD TABLE + FILTERS + COPY VIN -->
<script>
const fieldSelectors = {
    marketing: '.cell-marketing',
    model: '.cell-model',
    color: '.cell-color',
    interior: '.cell-interior',
    year: '.cell-year',
    vin: '.cell-vin',
    packages: '.cell-packages',
    price: '.cell-price',
    dealer: '.cell-dealer'
};

function normalize(text) {
    return (text || "").toLowerCase().trim();
}

function applyFilters() {
    const rows = document.querySelectorAll('#table-rows .table-row');
    const inputs = document.querySelectorAll('.filter-input');

    const filters = {};
    inputs.forEach(input => {
        const field = input.dataset.field;
        const value = normalize(input.value);
        if (value) filters[field] = value;
    });

    rows.forEach(row => {
        let visible = true;
        for (const field in filters) {
            const selector = fieldSelectors[field];
            if (!selector) continue;
            const cell = row.querySelector(selector);
            const cellText = normalize(cell ? cell.innerText : "");
            if (!cellText.includes(filters[field])) {
                visible = false;
                break;
            }
        }
        row.style.display = visible ? 'flex' : 'none';
    });
}

function setupFilterInputs() {
    const inputs = document.querySelectorAll('.filter-input');
    inputs.forEach(input => {
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
        input.addEventListener('blur', applyFilters);
    });
}

function initCopyButtons() {
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.copyTarget;
            const el = document.getElementById(id);
            if (!el) return;
            const text = el.textContent.trim();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    btn.classList.add('copied');
                    setTimeout(() => btn.classList.remove('copied'), 700);
                });
            } else {
                const temp = document.createElement('textarea');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                btn.classList.add('copied');
                setTimeout(() => btn.classList.remove('copied'), 700);
            }
        };
    });
}

async function loadCSV() {
    try {
        const response = await fetch('data.csv');
        if (!response.ok) {
            console.error('Failed to fetch data.csv', response.status, response.statusText);
            return;
        }

        const csvText = await response.text();
        const lines = csvText.trim().split(/\r?\n/);

        if (!lines.length) return;

        // Header row â†’ column names
        const headerLine = lines.shift();
        const headers = headerLine.split(',').map(h => h.trim());

        const vehicles = lines.map(line => {
            // CSV row parsing with quotes support
            const cols = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};
            headers.forEach((h, i) => {
                obj[h] = (cols[i] || '').replace(/^"|"$/g, '');
            });
            return obj;
        });

        // Update vehicle count
        const countEl = document.getElementById('count');
        if (countEl) countEl.textContent = vehicles.length;

        const table = document.getElementById('table-rows');
        table.innerHTML = '';

        vehicles.forEach((car, index) => {
            const row = document.createElement('div');
            row.className = 'table-row';

            const exteriorImage = car.exterior_image || '';
            const marketingName = car.marketing_name || 'M3 Sedan';
            const model = car.model || '';       // E90
            const extCode = car.ext_code || '';  // 300, A75, etc.
            const extRGB = car.ext_rgb || '';    // "255,255,255"
            const interiorCode = car.interior_code || '';
            const interiorImage = car.interior_image || '';
            const year = car.year || '';
            const vin = car.vin || '';
            const packages = car.packages || '';
            const price = car.price || '';
            const dealer = car.dealer || '';

            row.innerHTML = `
                <div class="cell cell-status">
                    <div class="status-circle">G</div>
                </div>

                <div class="cell cell-checkbox">
                    <input type="checkbox">
                </div>

                <div class="cell cell-marketing">
                    <div class="tooltip">
                        <div class="marketing-name" style="background-image:url('${exteriorImage}');">
                            <span>${marketingName}</span>
                        </div>
                        <div class="tooltiptext tooltip-red-content">
                            ${marketingName}
                        </div>
                    </div>
                </div>

                <div class="cell cell-model">
                    ${model}
                </div>

                <div class="cell cell-color">
                    <div class="tooltip">
                        <div class="color-cell">
                            <span class="circle" style="background-color: rgb(${extRGB});"></span>
                            <div class="label">${extCode}</div>
                        </div>
                        <div class="tooltiptext tooltip-red-content">
                            ${extCode}
                        </div>
                    </div>
                </div>

                <div class="cell cell-interior">
                    <div class="tooltip">
                        <div class="color-cell">
                            <span class="square" style="background-image:url('${interiorImage}');"></span>
                            <div class="label">${interiorCode}</div>
                        </div>
                        <div class="tooltiptext tooltip-red-content">
                            ${interiorCode}
                        </div>
                    </div>
                </div>

                <div class="cell cell-year">
                    ${year}
                </div>

                <div class="cell cell-vin">
                    <div class="tooltip">
                        <span class="vin-text" id="vin-${index}">${vin}</span>
                        <div class="tooltiptext tooltip-red-content">
                            ${vin}
                        </div>
                    </div>
                    <button class="copy-btn" data-copy-target="vin-${index}" title="Copy VIN">â§‰</button>
                </div>

                <div class="cell cell-packages">
                    <span class="packages-short">${packages}</span>
                </div>

                <div class="cell cell-price">
                    ${price}
                </div>

                <div class="cell cell-dealer">
                    ${dealer}
                </div>
            `;

            table.appendChild(row);
        });

        initCopyButtons();
        applyFilters();  // respect any filters already typed

    } catch (err) {
        console.error('Error loading CSV:', err);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    setupFilterInputs();
    loadCSV();
});
</script>

</body>
</html>
