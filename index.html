<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E9x M3 Inventory</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="app-shell">

    <!-- TOP NAV BAR -->
    <header class="top-nav">
        <div class="top-nav-left">
            <span class="top-nav-home">Home</span>
        </div>
        <div class="top-nav-center">
            <span>E9x M3 U.S</span>
            <span class="divider">|</span>
            <span>U.S Database - 00001</span>
        </div>
        <div class="top-nav-right">
            <span>Public User</span>
            <span class="user-icon">ðŸ‘¤</span>
        </div>
    </header>

    <!-- OWNER / INVENTORY HEADER -->
    <div class="owner-row">
        <div class="owner-pill"></div>
        <div class="owner-labels">
            <span class="owner-main">Owner images</span>
            <span class="owner-sub">E9x M3 Inventory</span>
        </div>
    </div>

    <!-- SUMMARY ROW -->
    <div class="summary-row">
        <div class="summary-left">
            <input type="checkbox" class="summary-checkbox">
            <span class="summary-text"><span id="count"></span> of 25,672 Vehicle(s)</span>
            <span class="badge-m3">M3</span>
        </div>
    </div>

    <!-- GRID -->
    <div class="grid-wrapper">
        <div class="grid-inner">

            <!-- COLUMN LABELS -->
            <div class="column-labels">
                <div class="header-cell header-status">Cat.</div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing">Model Name</div>
                <div class="header-cell header-model">Model</div>
                <div class="header-cell header-color">Ext.</div>
                <div class="header-cell header-interior">Int.</div>
                <div class="header-cell header-year">Yr.</div>
                <div class="header-cell header-vin">VIN</div>
                <div class="header-cell header-packages">Packages</div>
                <div class="header-cell header-price">MSRP</div>
                <div class="header-cell header-dealer">Dealer</div>
            </div>

            <!-- FILTER INPUT ROW -->
            <div class="table-header">
                <div class="header-cell header-status"></div>
                <div class="header-cell header-checkbox"></div>
                <div class="header-cell header-marketing"><input class="filter-input" data-field="marketing_name"></div>
                <div class="header-cell header-model"><input class="filter-input" data-field="model"></div>
                <div class="header-cell header-color"><input class="filter-input" data-field="ext_code"></div>
                <div class="header-cell header-interior"><input class="filter-input" data-field="interior_code"></div>
                <div class="header-cell header-year"><input class="filter-input" data-field="year"></div>
                <div class="header-cell header-vin"><input class="filter-input" data-field="vin"></div>
                <div class="header-cell header-packages"><input class="filter-input" data-field="packages"></div>
                <div class="header-cell header-price"><input class="filter-input" data-field="price"></div>
                <div class="header-cell header-dealer"><input class="filter-input" data-field="dealer"></div>
            </div>

            <!-- DYNAMIC ROWS GO HERE -->
            <div id="table-rows"></div>

        </div>
    </div>
</div>

<script>
/**
 * Simple CSV line splitter that respects "quoted,values"
 */
function splitCSVLine(line) {
    const matches = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    if (!matches) return [];
    return matches.map(v => v.replace(/^"|"$/g, ""));
}

async function loadCSV() {
    const res = await fetch("data.csv");
    const text = await res.text();

    const lines = text.trim().split("\n");
    if (lines.length <= 1) return;

    // first line is header, we don't actually need the names
    const dataLines = lines.slice(1);

    const cars = dataLines.map(splitCSVLine);

    // Update count
    document.getElementById("count").innerText = cars.length;

    const container = document.getElementById("table-rows");
    container.innerHTML = "";

    cars.forEach((cols, i) => {
        // Map by **fixed column index** based on your header:
        // 0: exterior_image
        // 1: marketing_name
        // 2: model
        // 3: chassis   (not used in UI right now)
        // 4: ext_code
        // 5: ext_rgb
        // 6: interior_code
        // 7: interior_image
        // 8: year
        // 9: vin
        // 10: packages
        const car = {
            exterior_image: cols[0] || "",
            marketing_name: cols[1] || "",
            model: cols[2] || "",
            chassis: cols[3] || "",
            ext_code: cols[4] || "",
            ext_rgb: cols[5] || "",
            interior_code: cols[6] || "",
            interior_image: cols[7] || "",
            year: cols[8] || "",
            vin: cols[9] || "",
            packages: cols[10] || "",
            price: cols[11] || "",
            dealer: cols[12] || ""
        };

        const row = document.createElement("div");
        row.className = "table-row";

        row.innerHTML = `
            <div class="cell cell-status"><div class="status-circle">G</div></div>
            <div class="cell cell-checkbox"><input type="checkbox"></div>

            <div class="cell cell-marketing">
                <div class="tooltip">
                    <div class="marketing-name" style="background-image:url('${car.exterior_image}')">
                        <span>${car.marketing_name}</span>
                    </div>
                </div>
            </div>

            <div class="cell cell-model">${car.model}</div>

            <div class="cell cell-color">
                <div class="color-cell">
                    <span class="circle" style="background-color: rgb(${car.ext_rgb});"></span>
                    <div class="label">${car.ext_code}</div>
                </div>
            </div>

            <div class="cell cell-interior">
                <div class="color-cell">
                    <span class="square" style="background-image:url('${car.interior_image}')"></span>
                    <div class="label">${car.interior_code}</div>
                </div>
            </div>

            <div class="cell cell-year">${car.year}</div>

            <div class="cell cell-vin">
                <span class="vin-text" id="vin-${i}">${car.vin}</span>
                <button class="copy-btn" data-copy-target="vin-${i}">â§‰</button>
            </div>

            <div class="cell cell-packages">${car.packages}</div>
            <div class="cell cell-price">${car.price}</div>
            <div class="cell cell-dealer">${car.dealer}</div>
        `;

        container.appendChild(row);
    });

    initCopyButtons();
    initFilters(cars);
}

function initCopyButtons() {
    document.querySelectorAll(".copy-btn").forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.copyTarget;
            const el = document.getElementById(id);
            if (!el) return;
            const text = el.textContent.trim();
            navigator.clipboard.writeText(text);
            btn.classList.add("copied");
            setTimeout(() => btn.classList.remove("copied"), 700);
        };
    });
}

/* Basic filtering by visible cell text */
function initFilters() {
    const inputs = document.querySelectorAll(".filter-input");

    function normalize(t) {
        return (t || "").toLowerCase().trim();
    }

    function applyFilters() {
        const filters = {};
        inputs.forEach(input => {
            const field = input.dataset.field;
            const val = normalize(input.value);
            if (val) filters[field] = val;
        });

        const rows = document.querySelectorAll("#table-rows .table-row");

        rows.forEach(row => {
            let visible = true;

            if (filters.marketing_name) {
                const text = normalize(row.querySelector(".cell-marketing")?.innerText);
                if (!text.includes(filters.marketing_name)) visible = false;
            }
            if (filters.model) {
                const text = normalize(row.querySelector(".cell-model")?.innerText);
                if (!text.includes(filters.model)) visible = false;
            }
            if (filters.ext_code) {
                const text = normalize(row.querySelector(".cell-color .label")?.innerText);
                if (!text.includes(filters.ext_code)) visible = false;
            }
            if (filters.interior_code) {
                const text = normalize(row.querySelector(".cell-interior .label")?.innerText);
                if (!text.includes(filters.interior_code)) visible = false;
            }
            if (filters.year) {
                const text = normalize(row.querySelector(".cell-year")?.innerText);
                if (!text.includes(filters.year)) visible = false;
            }
            if (filters.vin) {
                const text = normalize(row.querySelector(".cell-vin .vin-text")?.innerText);
                if (!text.includes(filters.vin)) visible = false;
            }
            if (filters.packages) {
                const text = normalize(row.querySelector(".cell-packages")?.innerText);
                if (!text.includes(filters.packages)) visible = false;
            }
            if (filters.price) {
                const text = normalize(row.querySelector(".cell-price")?.innerText);
                if (!text.includes(filters.price)) visible = false;
            }
            if (filters.dealer) {
                const text = normalize(row.querySelector(".cell-dealer")?.innerText);
                if (!text.includes(filters.dealer)) visible = false;
            }

            row.style.display = visible ? "flex" : "none";
        });
    }

    inputs.forEach(input => {
        input.addEventListener("keydown", e => {
            if (e.key === "Enter") applyFilters();
        });
    });
}

loadCSV();
</script>

</body>
</html>
